<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hemi Bros NFT Collection</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f0f0f0;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .upload-section {
            background: white;
            padding: 40px;
            margin: 20px 0;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        .upload-btn {
            padding: 15px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
        }
        .upload-btn:hover {
            background: #5568d3;
        }
        .checker-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .checker-title {
            color: white;
            font-size: 1.1em;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .checker-label {
            color: white;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 0.9em;
        }
        .search-box {
            display: flex;
            gap: 10px;
            max-width: 400px;
        }
        .search-input {
            width: 150px;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
        }
        .check-btn {
            padding: 8px 20px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
        }
        .check-btn:hover {
            background: #f0f0f0;
        }
        .filter-container {
            background: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px 0;
        }
        .filter-header h3 {
            font-size: 1.3em;
        }
        .toggle-icon {
            font-size: 1.5em;
            transition: transform 0.3s;
        }
        .toggle-icon.open {
            transform: rotate(180deg);
        }
        .filter-content {
            margin-top: 20px;
            display: none;
        }
        .filter-content.show {
            display: block;
        }
        .rarity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .rarity-btn {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .rarity-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .rarity-btn.active {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .rarity-icon {
            font-size: 1.5em;
            margin-bottom: 5px;
            display: none;
        }
        .rarity-name {
            font-weight: 600;
            margin: 5px 0;
        }
        .rarity-count {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }
        .supply-label {
            display: block;
            font-size: 0.8em;
            color: #888;
        }
        .count-label {
            display: block;
            font-size: 0.8em;
            color: #888;
            margin-top: 3px;
        }
        .active-filters {
            background: #f8f9fa;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            display: none;
        }
        .active-filters.show {
            display: block;
        }
        .active-filters h4 {
            margin: 0 0 10px 0;
            font-size: 1em;
            color: #555;
        }
        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .filter-tag {
            background: #667eea;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }
        .filter-tag-close {
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
            line-height: 1;
        }
        .filter-tag-close:hover {
            color: #ffcccc;
        }
        .trait-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        .trait-dropdown {
            position: relative;
        }
        .dropdown-btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dropdown-btn:hover {
            background: #5568d3;
        }
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .dropdown-menu.show {
            display: block;
        }
        .dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        .dropdown-item:hover {
            background: #f8f9fa;
        }
        .dropdown-item.selected {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        .dropdown-item:last-child {
            border-bottom: none;
        }
        .reset-btn {
            padding: 15px 30px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            margin-top: 15px;
        }
        .reset-btn:hover {
            background: #b91c1c;
        }
        .results-info {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .summary-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        .summary-card {
            background: linear-gradient(145deg, #f8f9fa 0%, #ffffff 100%);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
        }
        .summary-title {
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 12px;
            color: #1f2937;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .summary-item:last-child {
            border-bottom: none;
        }
        .summary-label {
            font-size: 0.9em;
            color: #555;
        }
        .summary-count {
            font-weight: 600;
            font-size: 0.9em;
            color: #667eea;
        }
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(225px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .nft-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.06);
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
        }
        .nft-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 24px rgba(102, 126, 234, 0.15), 0 6px 12px rgba(0,0,0,0.1);
            border-color: #667eea;
            border-width: 4px;
        }
        .nft-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-bottom: 3px solid #e5e7eb;
            background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%);
        }
        .nft-info {
            padding: 15px;
            background: linear-gradient(to bottom, #ffffff 0%, #fafbfc 100%);
        }
        .nft-id {
            font-size: 1.35em;
            font-weight: bold;
            margin-bottom: 9px;
            color: #1f2937;
            text-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .best-rarity {
            font-size: 1.1em;
            font-weight: bold;
            margin: 7.5px 0;
            line-height: 1.5;
        }
        .trait-item {
            margin: 7.5px 0;
            font-size: 0.825em;
            line-height: 1.5;
        }
        .trait-label {
            font-weight: 600;
            color: #555;
        }
        .owner-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 2px solid #e5e7eb;
        }
        .owner-label {
            font-weight: 600;
            color: #555;
            font-size: 0.85em;
            margin-bottom: 6px;
        }
        .owner-address {
            font-family: 'Courier New', monospace;
            font-size: 0.7em;
            color: #667eea;
            background: #f0f4ff;
            padding: 6px 8px;
            border-radius: 6px;
            word-break: break-all;
            border: 1px solid #d4dbf7;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }
        .owner-address-text {
            flex: 1;
        }
        .copy-btn {
            padding: 4px 8px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            white-space: nowrap;
            transition: background 0.2s;
        }
        .copy-btn:hover {
            background: #5568d3;
        }
        .copy-btn.copied {
            background: #16A34A;
        }
        .fetch-owner-btn {
            width: 100%;
            padding: 8px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            transition: background 0.2s;
        }
        .fetch-owner-btn:hover {
            background: #5568d3;
        }
        .fetch-owner-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .contract-link {
            display: inline-block;
            margin-top: 6px;
            font-size: 0.75em;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s;
        }
        .contract-link:hover {
            color: #5568d3;
            text-decoration: underline;
        }
        .owner-loading {
            font-size: 0.75em;
            color: #6b7280;
            font-style: italic;
        }
        .offer-btn {
            width: 100%;
            padding: 8px;
            background: #16A34A;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 8px;
            transition: background 0.2s;
        }
        .offer-btn:hover {
            background: #15803d;
        }
        .offers-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 2px solid #e5e7eb;
        }
        .offers-title {
            font-weight: 600;
            font-size: 0.85em;
            margin-bottom: 8px;
            color: #555;
        }
        .offer-item {
            background: #f9fafb;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 0.75em;
            border: 1px solid #e5e7eb;
        }
        .offer-amount {
            font-weight: 700;
            color: #16A34A;
            font-size: 1.1em;
        }
        .offer-wallet {
            font-family: 'Courier New', monospace;
            color: #667eea;
            font-size: 0.9em;
        }
        .offer-message {
            color: #6b7280;
            margin-top: 4px;
            font-style: italic;
        }
        .offer-time {
            color: #9ca3af;
            font-size: 0.85em;
            margin-top: 4px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        .modal-header {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #1f2937;
        }
        .modal-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
        }
        .modal-textarea {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            min-height: 80px;
            resize: vertical;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .modal-btn-primary {
            background: #667eea;
            color: white;
        }
        .modal-btn-primary:hover {
            background: #5568d3;
        }
        .modal-btn-secondary {
            background: #e5e7eb;
            color: #1f2937;
        }
        .modal-btn-secondary:hover {
            background: #d1d5db;
        }
        .wallet-info {
            background: #f0f4ff;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #667eea;
        }
        .grail { color: #DC2626; font-weight: bold; }
        .legendary { color: #EA580C; font-weight: bold; }
        .epic { color: #9333EA; font-weight: bold; }
        .rare { color: #16A34A; font-weight: bold; }
        .uncommon { color: #6B7280; font-weight: bold; }
        .common { color: #000; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé® Hemi Bros NFT Collection</h1>
        <p id="total-count"></p>
    </div>

    <div class="container">
        <div id="upload-section" class="upload-section">
            <h2>Upload Your CSV File</h2>
            <p style="color: #666; margin: 15px 0;">Choose a CSV file containing your Hemi Bros NFT data</p>
            <input type="file" id="file-input" accept=".csv" style="display: none;">
            <label for="file-input" class="upload-btn">Choose CSV File</label>
        </div>

        <div id="main-content" class="hidden">
            <div class="checker-section">
                <div class="checker-title">üîç Rarity Checker</div>
                <div class="checker-label">Enter NFT ID:</div>
                <div class="search-box">
                    <input type="text" id="search-input" class="search-input" placeholder="Enter ID">
                    <button class="check-btn" onclick="searchById()">Check</button>
                </div>
            </div>

            <div class="checker-section" style="margin-top: 15px;">
                <div class="checker-title">üë§ Owner Search</div>
                <div class="checker-label">Enter Owner Address:</div>
                <div class="search-box" style="max-width: 100%;">
                    <input type="text" id="owner-search-input" class="search-input" style="flex: 1; width: auto;" placeholder="0x..." onkeypress="if(event.key==='Enter') searchByOwner()">
                    <button class="check-btn" onclick="searchByOwner()">Find NFTs</button>
                </div>
            </div>

            <div class="filter-container">
                <div class="filter-header" onclick="toggleSection('rarity')">
                    <h3>Filter by Rarity</h3>
                    <span class="toggle-icon" id="rarity-toggle">‚ñº</span>
                </div>
                <div class="filter-content show" id="rarity-content">
                    <div class="rarity-grid" id="rarity-grid"></div>
                </div>
            </div>

            <div class="filter-container">
                <div class="filter-header" onclick="toggleSection('trait')">
                    <h3>Filter by Trait</h3>
                    <span class="toggle-icon open" id="trait-toggle">‚ñº</span>
                </div>
                <div class="filter-content show" id="trait-content">
                    <div class="trait-grid">
                        <div class="trait-dropdown">
                            <button class="dropdown-btn" onclick="toggleDropdown('broType')">
                                Bro Type <span>‚ñº</span>
                            </button>
                            <div class="dropdown-menu" id="broType-menu"></div>
                        </div>
                        <div class="trait-dropdown">
                            <button class="dropdown-btn" onclick="toggleDropdown('headwear')">
                                Headwear <span>‚ñº</span>
                            </button>
                            <div class="dropdown-menu" id="headwear-menu"></div>
                        </div>
                        <div class="trait-dropdown">
                            <button class="dropdown-btn" onclick="toggleDropdown('clothes')">
                                Clothes <span>‚ñº</span>
                            </button>
                            <div class="dropdown-menu" id="clothes-menu"></div>
                        </div>
                        <div class="trait-dropdown">
                            <button class="dropdown-btn" onclick="toggleDropdown('eyes')">
                                Eyes <span>‚ñº</span>
                            </button>
                            <div class="dropdown-menu" id="eyes-menu"></div>
                        </div>
                        <div class="trait-dropdown">
                            <button class="dropdown-btn" onclick="toggleDropdown('eyewear')">
                                Eyewear <span>‚ñº</span>
                            </button>
                            <div class="dropdown-menu" id="eyewear-menu"></div>
                        </div>
                        <div class="trait-dropdown">
                            <button class="dropdown-btn" onclick="toggleDropdown('mouth')">
                                Mouth <span>‚ñº</span>
                            </button>
                            <div class="dropdown-menu" id="mouth-menu"></div>
                        </div>
                    </div>
                    <button class="reset-btn" onclick="resetFilters()">Reset Filters</button>
                    <div id="active-filters" class="active-filters">
                        <h4>Active Filters:</h4>
                        <div class="filter-tags" id="filter-tags"></div>
                    </div>
                </div>
            </div>

            <div id="results-info" class="results-info hidden"></div>
            <div class="results-grid" id="results-grid"></div>
        </div>
    </div>

    <div id="offer-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Make an Offer</div>
            <div id="modal-nft-info"></div>
            <div class="wallet-info" id="modal-wallet-info">Connect wallet to continue...</div>
            <input type="text" id="offer-amount" class="modal-input" placeholder="Offer Amount (ETH)" disabled>
            <textarea id="offer-message" class="modal-textarea" placeholder="Message (optional)" disabled></textarea>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeOfferModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="submit-offer-btn">Connect Wallet</button>
            </div>
        </div>
    </div>

    <script>
        let allNfts = [];
        let currentOwnerFilter = null;
        let connectedWallet = null;
        let currentOfferNFT = null;
        const CONTRACT_ADDRESS = '0xEAB71F90235E6b885C05aFFF3BAF0E41244cf874';
        const HEMI_RPC = 'https://rpc.hemi.network/rpc';
        
        // Initialize Supabase
        const SUPABASE_URL = 'https://bmopbmxhckzekvpslfde.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtb3BibXhoY2t6ZWt2cHNsZmRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NTMyMjIsImV4cCI6MjA3NjAyOTIyMn0.OvLCYaYRqB11VSiegvOE-7XcMAtVnVzjLP5RqPE-Wno';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function fetchNFTOwner(tokenId, cardId) {
            const button = document.getElementById(`fetch-btn-${cardId}`);
            const ownerDiv = document.getElementById(`owner-${cardId}`);
            
            button.disabled = true;
            button.textContent = 'Fetching...';
            
            try {
                // ERC-721 ownerOf function signature
                const data = '0x6352211e' + tokenId.toString(16).padStart(64, '0');
                
                const response = await fetch(HEMI_RPC, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: 'eth_call',
                        params: [{
                            to: CONTRACT_ADDRESS,
                            data: data
                        }, 'latest'],
                        id: 1
                    })
                });

                const result = await response.json();
                
                if (result.result) {
                    // Extract address from result (remove leading zeros and 0x)
                    const ownerAddress = '0x' + result.result.slice(-40);
                    
                    ownerDiv.innerHTML = `
                        <div class="owner-label">Current Owner:</div>
                        <div class="owner-address">
                            <span class="owner-address-text">${ownerAddress}</span>
                            <button class="copy-btn" onclick="copyToClipboard('${ownerAddress}', this)">Copy</button>
                        </div>
                        <a href="https://explorer.hemi.xyz/token/${CONTRACT_ADDRESS}?tab=inventory&holder_address_hash=${ownerAddress}" target="_blank" class="contract-link">
                            View Hemi Bros Holdings ‚Üí
                        </a>
                    `;
                    
                    // Add Make Offer button
                    const makeOfferBtn = document.createElement('button');
                    makeOfferBtn.className = 'offer-btn';
                    makeOfferBtn.textContent = 'Make an Offer';
                    makeOfferBtn.onclick = () => openOfferModal(tokenId, document.getElementById('nft-name-' + cardId).textContent);
                    ownerDiv.appendChild(makeOfferBtn);
                    
                    // Load and display offers
                    const offersDiv = document.createElement('div');
                    offersDiv.className = 'offers-section';
                    offersDiv.id = `offers-${tokenId}`;
                    ownerDiv.appendChild(offersDiv);
                    loadOffersForNFT(tokenId);
                } else {
                    ownerDiv.innerHTML = '<div class="owner-loading">Could not fetch owner data</div>';
                    button.disabled = false;
                    button.textContent = 'Fetch Owner';
                }
            } catch (error) {
                console.error('Error fetching owner:', error);
                ownerDiv.innerHTML = '<div class="owner-loading">Error fetching owner data</div>';
                button.disabled = false;
                button.textContent = 'Fetch Owner';
            }
        }

        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy address');
            });
        }
        
        // --- START OF FIXED CODE ---
        
        function updateOfferModalUI(isConnected) {
            const modalWalletInfo = document.getElementById('modal-wallet-info');
            const offerAmountInput = document.getElementById('offer-amount');
            const offerMessageTextarea = document.getElementById('offer-message');
            const submitOfferBtn = document.getElementById('submit-offer-btn');
        
            if (isConnected && connectedWallet) {
                modalWalletInfo.textContent = `Connected: ${connectedWallet.slice(0, 6)}...${connectedWallet.slice(-4)}`;
                offerAmountInput.disabled = false;
                offerMessageTextarea.disabled = false;
                submitOfferBtn.disabled = false;
                submitOfferBtn.textContent = 'Submit Offer';
                submitOfferBtn.onclick = submitOffer; // Set to submit
            } else {
                modalWalletInfo.textContent = 'Connect wallet to continue...';
                offerAmountInput.disabled = true;
                offerMessageTextarea.disabled = true;
                submitOfferBtn.disabled = false;
                submitOfferBtn.textContent = 'Connect Wallet';
                submitOfferBtn.onclick = connectWallet; // Set to connect
            }
        }
        
        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const provider = new ethers.providers.Web3Provider(window.ethereum);
        
                    // Request account access
                    await provider.send("eth_requestAccounts", []);
        
                    // Check if on Hemi network
                    const network = await provider.getNetwork();
                    const HEMI_CHAIN_ID = 43111; // Hemi mainnet chain ID
        
                    if (network.chainId !== HEMI_CHAIN_ID) {
                        try {
                            // Try to switch to Hemi network
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: '0x' + HEMI_CHAIN_ID.toString(16) }], // Correctly formatted hex
                            });
                        } catch (switchError) {
                            // If network doesn't exist, add it
                            if (switchError.code === 4902) {
                                try {
                                    await window.ethereum.request({
                                        method: 'wallet_addEthereumChain',
                                        params: [{
                                            chainId: '0x' + HEMI_CHAIN_ID.toString(16), // Correctly formatted hex
                                            chainName: 'Hemi Network',
                                            nativeCurrency: {
                                                name: 'Ethereum',
                                                symbol: 'ETH',
                                                decimals: 18
                                            },
                                            rpcUrls: ['https://rpc.hemi.network/rpc'],
                                            blockExplorerUrls: ['https://explorer.hemi.xyz/']
                                        }]
                                    });
                                } catch (addError) {
                                    console.error('Error adding Hemi network:', addError);
                                    alert('Failed to add Hemi network. Please add it manually in your wallet.');
                                    return false;
                                }
                            } else {
                                throw switchError;
                            }
                        }
                    }
        
                    // Get signer after network is correct
                    const signer = provider.getSigner();
                    connectedWallet = await signer.getAddress();
        
                    // Update UI
                    updateOfferModalUI(true);
        
                    return true;
                } catch (error) {
                    console.error('Error connecting wallet:', error);
                    alert('Failed to connect wallet. Please make sure you have MetaMask or Rabby installed and try again.');
                    return false;
                }
            } else {
                alert('Please install MetaMask, Rabby, or another Web3 wallet to make offers.');
                return false;
            }
        }
        
        function openOfferModal(nftId, nftName) {
            currentOfferNFT = nftId;
            document.getElementById('modal-nft-info').innerHTML = `<strong>NFT #${nftId}</strong><br><span style="font-size: 0.9em; color: #666;">${nftName}</span>`;
            document.getElementById('offer-modal').classList.add('show');
        
            // Reset form
            document.getElementById('offer-amount').value = '';
            document.getElementById('offer-message').value = '';
        
            updateOfferModalUI(!!connectedWallet);
        }

        // --- END OF FIXED CODE ---

        function closeOfferModal() {
            document.getElementById('offer-modal').classList.remove('show');
        }

        async function submitOffer() {
            if (!connectedWallet) {
                alert('Please connect your wallet first');
                return;
            }

            const amount = document.getElementById('offer-amount').value.trim();
            const message = document.getElementById('offer-message').value.trim();

            if (!amount) {
                alert('Please enter an offer amount');
                return;
            }

            if (isNaN(amount) || parseFloat(amount) <= 0) {
                alert('Please enter a valid offer amount');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('offers')
                    .insert([
                        {
                            nft_id: currentOfferNFT.toString(),
                            wallet_address: connectedWallet,
                            offer_amount: amount,
                            message: message || null
                        }
                    ]);

                if (error) throw error;

                alert('Offer submitted successfully!');
                closeOfferModal();
                
                // Reload offers for this NFT
                loadOffersForNFT(currentOfferNFT);
            } catch (error) {
                console.error('Error submitting offer:', error);
                alert('Failed to submit offer. Please try again.');
            }
        }

        async function loadOffersForNFT(nftId) {
            try {
                const { data, error } = await supabase
                    .from('offers')
                    .select('*')
                    .eq('nft_id', nftId.toString())
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const offersContainer = document.getElementById(`offers-${nftId}`);
                if (offersContainer) {
                    if (data && data.length > 0) {
                        offersContainer.innerHTML = `
                            <div class="offers-title">Recent Offers (${data.length}):</div>
                            ${data.slice(0, 3).map(offer => {
                                const date = new Date(offer.created_at);
                                const timeAgo = getTimeAgo(date);
                                return `
                                    <div class="offer-item">
                                        <div class="offer-amount">${offer.offer_amount} ETH</div>
                                        <div class="offer-wallet">${offer.wallet_address.slice(0, 6)}...${offer.wallet_address.slice(-4)}</div>
                                        ${offer.message ? `<div class="offer-message">"${offer.message}"</div>` : ''}
                                        <div class="offer-time">${timeAgo}</div>
                                    </div>
                                `;
                            }).join('')}
                            ${data.length > 3 ? `<div style="font-size: 0.75em; color: #6b7280; margin-top: 6px;">+${data.length - 3} more offer(s)</div>` : ''}
                        `;
                    } else {
                        offersContainer.innerHTML = '<div class="offers-title">No offers yet</div>';
                    }
                }
            } catch (error) {
                console.error('Error loading offers:', error);
            }
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            const intervals = {
                year: 31536000,
                month: 2592000,
                week: 604800,
                day: 86400,
                hour: 3600,
                minute: 60
            };

            for (const [unit, secondsInUnit] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / secondsInUnit);
                if (interval >= 1) {
                    return `${interval} ${unit}${interval > 1 ? 's' : ''} ago`;
                }
            }
            return 'Just now';
        }

        async function getOwnerOfToken(tokenId) {
            try {
                const data = '0x6352211e' + tokenId.toString(16).padStart(64, '0');
                
                const response = await fetch(HEMI_RPC, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: 'eth_call',
                        params: [{
                            to: CONTRACT_ADDRESS,
                            data: data
                        }, 'latest'],
                        id: 1
                    })
                });

                const result = await response.json();
                
                if (result.result) {
                    return '0x' + result.result.slice(-40);
                }
                return null;
            } catch (error) {
                console.error('Error fetching owner for token', tokenId, error);
                return null;
            }
        }

        async function searchByOwner() {
            const ownerInput = document.getElementById('owner-search-input');
            let searchAddress = ownerInput.value.trim().toLowerCase();
            
            if (!searchAddress) {
                alert('Please enter an owner address');
                return;
            }

            // Ensure address starts with 0x
            if (!searchAddress.startsWith('0x')) {
                searchAddress = '0x' + searchAddress;
            }

            // Validate address format (basic check)
            if (searchAddress.length !== 42) {
                alert('Invalid address format. Address should be 42 characters (including 0x)');
                return;
            }

            const info = document.getElementById('results-info');
            info.innerHTML = '<h3>Fetching NFTs owned by ' + searchAddress + '...</h3>';
            info.classList.remove('hidden');

            try {
                let allOwnedTokenIds = [];
                let nextPageParams = null;
                let pageCount = 0;
                
                // Keep fetching pages until there are no more
                do {
                    pageCount++;
                    info.innerHTML = '<h3>Fetching page ' + pageCount + '...</h3>';
                    
                    let apiUrl = `https://explorer.hemi.xyz/api/v2/tokens/${CONTRACT_ADDRESS}/instances?holder_address_hash=${searchAddress}`;
                    
                    // Add pagination params if we have them
                    if (nextPageParams) {
                        const params = new URLSearchParams(nextPageParams);
                        apiUrl += '&' + params.toString();
                    }
                    
                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    
                    if (data.items && data.items.length > 0) {
                        // Add token IDs from this page
                        const tokenIds = data.items.map(item => item.id);
                        allOwnedTokenIds = allOwnedTokenIds.concat(tokenIds);
                        
                        // Check if there's a next page
                        nextPageParams = data.next_page_params;
                    } else {
                        break;
                    }
                    
                    // Safety limit to prevent infinite loops
                    if (pageCount > 100) {
                        console.warn('Reached page limit');
                        break;
                    }
                    
                } while (nextPageParams);
                
                if (allOwnedTokenIds.length > 0) {
                    // Filter our NFT collection to show only owned NFTs
                    const ownedNFTs = allNfts.filter(nft => 
                        allOwnedTokenIds.includes(nft['ID'].toString())
                    );

                    // Set owner filter as active
                    currentOwnerFilter = searchAddress;
                    currentFilters = { rarity: null, traits: {}, ownerNFTs: ownedNFTs };
                    document.querySelectorAll('.rarity-btn').forEach(b => b.classList.remove('active'));
                    updateActiveFilters();
                    updateDropdownHighlights();

                    if (ownedNFTs.length > 0) {
                        displayResults(ownedNFTs, `Found ${ownedNFTs.length} NFT(s) owned by ${searchAddress}`, true);
                    } else {
                        displayResults([], `No NFTs found in your collection data for address ${searchAddress}`, true);
                    }
                } else {
                    const explorerUrl = `https://explorer.hemi.xyz/token/${CONTRACT_ADDRESS}?tab=inventory&holder_address_hash=${searchAddress}`;
                    info.innerHTML = '<h3>No NFTs found for this address or unable to fetch data.</h3><p style="font-size: 0.9em; margin-top: 10px;">You can view this address directly on <a href="' + explorerUrl + '" target="_blank">Hemi Explorer</a></p>';
                }
            } catch (error) {
                console.error('Error fetching from Hemi Explorer:', error);
                info.innerHTML = '<h3>Unable to fetch data from Hemi Explorer</h3><p style="font-size: 0.9em; margin-top: 10px;">Due to browser restrictions, you may need to view this address directly on <a href="https://explorer.hemi.xyz/token/' + CONTRACT_ADDRESS + '?tab=inventory&holder_address_hash=' + searchAddress + '" target="_blank">Hemi Explorer</a></p>';
            }
        }
        let currentFilters = {
            rarity: null,
            traits: {},
            ownerNFTs: null
        };

        function toggleSection(section) {
            const content = document.getElementById(section + '-content');
            const toggle = document.getElementById(section + '-toggle');
            content.classList.toggle('show');
            toggle.classList.toggle('open');
        }

        function toggleDropdown(trait) {
            const menu = document.getElementById(trait + '-menu');
            document.querySelectorAll('.dropdown-menu').forEach(m => {
                if (m !== menu) m.classList.remove('show');
            });
            menu.classList.toggle('show');
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.trait-dropdown')) {
                document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
            }
        });

        function getBestRarity(nft) {
            const traits = [
                nft['Bro Type'], nft['Headwear'], nft['Clothes'],
                nft['Eyes'], nft['Eyewear'], nft['Mouth Items'], nft['Background']
            ];
            
            let lowestSupply = 999999;
            traits.forEach(trait => {
                if (!trait) return;
                const match = trait.toString().match(/\((\d+)\)/);
                if (match) {
                    lowestSupply = Math.min(lowestSupply, parseInt(match[1]));
                }
            });
            
            if (lowestSupply === 1) return 'Grail';
            if (lowestSupply <= 10) return 'Legendary';
            if (lowestSupply <= 25) return 'Epic';
            if (lowestSupply <= 50) return 'Rare';
            if (lowestSupply <= 100) return 'Uncommon';
            return 'Common';
        }

        function getRarityClass(trait) {
            if (!trait) return 'common';
            const match = trait.toString().match(/\((\d+)\)/);
            if (!match) return 'common';
            const supply = parseInt(match[1]);
            if (supply === 1) return 'grail';
            if (supply <= 10) return 'legendary';
            if (supply <= 25) return 'epic';
            if (supply <= 50) return 'rare';
            if (supply <= 100) return 'uncommon';
            return 'common';
        }

        function getRarityRange(tier) {
            const ranges = {
                'Grail': '(1)',
                'Legendary': '(2-10)',
                'Epic': '(11-25)',
                'Rare': '(26-50)',
                'Uncommon': '(51-100)',
                'Common': '(101+)'
            };
            return ranges[tier] || '';
        }

        function createRarityButtons() {
            const rarityCounts = {
                'Grail': 0, 'Legendary': 0, 'Epic': 0, 'Rare': 0, 'Uncommon': 0, 'Common': 0
            };
            allNfts.forEach(nft => {
                rarityCounts[getBestRarity(nft)]++;
            });

            const rarities = [
                { name: 'Grail', color: 'grail' },
                { name: 'Legendary', color: 'legendary' },
                { name: 'Epic', color: 'epic' },
                { name: 'Rare', color: 'rare' },
                { name: 'Uncommon', color: 'uncommon' },
                { name: 'Common', color: 'common' }
            ];

            const grid = document.getElementById('rarity-grid');
            grid.innerHTML = rarities.map(r => `
                <div class="rarity-btn" onclick="filterByRarity('${r.name}', this)">
                    <div class="rarity-name ${r.color}">${r.name}</div>
                    <div class="rarity-count">
                        <span class="supply-label">Supply: ${getRarityRange(r.name)}</span>
                        <span class="count-label">Total Count: ${rarityCounts[r.name]}</span>
                    </div>
                </div>
            `).join('');
        }

        function populateTraitDropdowns() {
            const traitMaps = {
                broType: new Set(),
                headwear: new Set(),
                clothes: new Set(),
                eyes: new Set(),
                eyewear: new Set(),
                mouth: new Set()
            };

            allNfts.forEach(nft => {
                if (nft['Bro Type']) traitMaps.broType.add(nft['Bro Type']);
                if (nft['Headwear']) traitMaps.headwear.add(nft['Headwear']);
                if (nft['Clothes']) traitMaps.clothes.add(nft['Clothes']);
                if (nft['Eyes']) traitMaps.eyes.add(nft['Eyes']);
                if (nft['Eyewear']) traitMaps.eyewear.add(nft['Eyewear']);
                if (nft['Mouth Items']) traitMaps.mouth.add(nft['Mouth Items']);
            });

            Object.keys(traitMaps).forEach(trait => {
                const menu = document.getElementById(trait + '-menu');
                const items = Array.from(traitMaps[trait]).sort();
                menu.innerHTML = items.map(item => {
                    const escapedItem = item.replace(/'/g, '&#39;').replace(/"/g, '&quot;');
                    return `<div class="dropdown-item" data-trait="${trait}" data-value="${escapedItem}" onclick='filterByTrait("${trait}", \`${escapedItem}\`)'>${item}</div>`;
                }).join('');
            });
        }

        function updateDropdownHighlights() {
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('selected');
            });

            const fieldMap = {
                broType: 'Bro Type',
                headwear: 'Headwear',
                clothes: 'Clothes',
                eyes: 'Eyes',
                eyewear: 'Eyewear',
                mouth: 'Mouth Items'
            };

            Object.keys(currentFilters.traits).forEach(trait => {
                const value = currentFilters.traits[trait];
                const traitType = Object.keys(fieldMap).find(key => fieldMap[key] === trait);
                if (traitType) {
                    document.querySelectorAll(`[data-trait="${traitType}"][data-value="${value.replace(/"/g, '&quot;')}"]`).forEach(item => {
                        item.classList.add('selected');
                    });
                }
            });
        }

        function updateActiveFilters() {
            const container = document.getElementById('active-filters');
            const tagsContainer = document.getElementById('filter-tags');
            const tags = [];

            if (currentOwnerFilter) {
                tags.push(`<div class="filter-tag">
                    Owner: ${currentOwnerFilter.slice(0, 6)}...${currentOwnerFilter.slice(-4)}
                    <span class="filter-tag-close" onclick="removeOwnerFilter()">√ó</span>
                </div>`);
            }

            if (currentFilters.rarity) {
                tags.push(`<div class="filter-tag">
                    Rarity: ${currentFilters.rarity}
                    <span class="filter-tag-close" onclick="removeRarityFilter()">√ó</span>
                </div>`);
            }

            Object.keys(currentFilters.traits).forEach(trait => {
                const value = currentFilters.traits[trait];
                tags.push(`<div class="filter-tag">
                    ${trait}: ${value.split('(')[0].trim()}
                    <span class="filter-tag-close" onclick="removeTraitFilter('${trait}')">√ó</span>
                </div>`);
            });

            if (tags.length > 0) {
                tagsContainer.innerHTML = tags.join('');
                container.classList.add('show');
            } else {
                container.classList.remove('show');
            }
        }

        function removeOwnerFilter() {
            currentOwnerFilter = null;
            currentFilters.ownerNFTs = null;
            document.getElementById('owner-search-input').value = '';
            updateActiveFilters();
            applyFilters();
        }

        function removeRarityFilter() {
            currentFilters.rarity = null;
            document.querySelectorAll('.rarity-btn').forEach(b => b.classList.remove('active'));
            updateActiveFilters();
            applyFilters();
        }

        function removeTraitFilter(trait) {
            delete currentFilters.traits[trait];
            updateActiveFilters();
            updateDropdownHighlights();
            applyFilters();
        }

        function filterByRarity(tier, btn) {
            document.querySelectorAll('.rarity-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            currentFilters.rarity = tier;
            currentFilters.traits = {};
            updateActiveFilters();
            updateDropdownHighlights();
            applyFilters();
        }

        function filterByTrait(traitType, value) {
            const fieldMap = {
                broType: 'Bro Type',
                headwear: 'Headwear',
                clothes: 'Clothes',
                eyes: 'Eyes',
                eyewear: 'Eyewear',
                mouth: 'Mouth Items'
            };
            currentFilters.traits[fieldMap[traitType]] = value;
            currentFilters.rarity = null;
            document.querySelectorAll('.rarity-btn').forEach(b => b.classList.remove('active'));
            updateActiveFilters();
            updateDropdownHighlights();
            applyFilters();
        }

        function applyFilters() {
            let filtered = currentFilters.ownerNFTs || allNfts;

            if (currentFilters.rarity) {
                filtered = filtered.filter(nft => getBestRarity(nft) === currentFilters.rarity);
            }

            Object.keys(currentFilters.traits).forEach(trait => {
                filtered = filtered.filter(nft => nft[trait] === currentFilters.traits[trait]);
            });

            displayResults(filtered, `Showing ${filtered.length} results`);
        }

        function resetFilters() {
            currentFilters = { rarity: null, traits: {}, ownerNFTs: currentFilters.ownerNFTs };
            document.querySelectorAll('.rarity-btn').forEach(b => b.classList.remove('active'));
            updateActiveFilters();
            updateDropdownHighlights();
            applyFilters();
        }

        function searchById() {
            const id = document.getElementById('search-input').value.trim();
            if (!id) return;

            const found = allNfts.find(nft => nft['ID']?.toString() === id);
            if (found) {
                currentFilters = { rarity: null, traits: {} };
                document.querySelectorAll('.rarity-btn').forEach(b => b.classList.remove('active'));
                updateActiveFilters();
                updateDropdownHighlights();
                displayResults([found], `Found NFT #${id}`, true);
            } else {
                alert(`NFT #${id} not found`);
            }
        }

        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchById();
        });

        function generateSummary(nfts) {
            if (nfts.length === 0) return '';
            // Count by Bro Type
            const broTypeCounts = {};
            nfts.forEach(nft => {
                const broType = nft['Bro Type'] || 'Unknown';
                broTypeCounts[broType] = (broTypeCounts[broType] || 0) + 1;
            });

            // Count by Best Rarity
            const rarityCounts = {};
            nfts.forEach(nft => {
                const rarity = getBestRarity(nft);
                rarityCounts[rarity] = (rarityCounts[rarity] || 0) + 1;
            });

            // Sort by count descending
            const sortedBroTypes = Object.entries(broTypeCounts).sort((a, b) => b[1] - a[1]);
            const rarityOrder = ['Grail', 'Legendary', 'Epic', 'Rare', 'Uncommon', 'Common'];
            const sortedRarities = rarityOrder.filter(r => rarityCounts[r]).map(r => [r, rarityCounts[r]]);

            const summaryLabel = currentOwnerFilter ? '<h4 style="margin: 15px 0 10px 0; color: #555;">Summary of holdings:</h4>' : '';

            return `
                ${summaryLabel}
                <div class="summary-section">
                    <div class="summary-card">
                        <div class="summary-title">Bro Types (${nfts.length} total)</div>
                        ${sortedBroTypes.map(([type, count]) => `
                            <div class="summary-item">
                                <span class="summary-label">${type.split('(')[0].trim()}</span>
                                <span class="summary-count">${count}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">Best Rarity Distribution</div>
                        ${sortedRarities.map(([rarity, count]) => `
                            <div class="summary-item">
                                <span class="summary-label ${rarity.toLowerCase()}">${rarity}</span>
                                <span class="summary-count">${count}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function displayResults(nfts, message, shouldScroll) {
            const info = document.getElementById('results-info');
            const grid = document.getElementById('results-grid');

            if (message) {
                info.innerHTML = `<h3>${message}</h3>` + generateSummary(nfts);
                info.classList.remove('hidden');
            } else {
                info.classList.add('hidden');
            }

            grid.innerHTML = nfts.map((nft, index) => {
                const imageUrl = nft['Image'] || nft['image'] || '';
                const cardId = `card-${Date.now()}-${index}`;
                const tokenId = nft['ID'];
                return `
                <div class="nft-card">
                    <img src="${imageUrl}" alt="NFT ${nft['ID']}" class="nft-image" onerror="this.src='https://via.placeholder.com/225'">
                    <div class="nft-info">
                        <div class="nft-id" id="nft-name-${cardId}">ID: #${nft['ID']}</div>
                        <div class="best-rarity">
                            <span class="trait-label">Best Rarity:</span>
                            <span class="${getBestRarity(nft).toLowerCase()}">${getBestRarity(nft)}</span>
                        </div>
                        <div class="trait-item">
                            <span class="trait-label">Bro Type:</span>
                            <span class="${getRarityClass(nft['Bro Type'])}">${(nft['Bro Type'] || 'None').split('(')[0].trim()}</span>
                        </div>
                        <div class="trait-item">
                            <span class="trait-label">Headwear:</span>
                            <span class="${getRarityClass(nft['Headwear'])}">${(nft['Headwear'] || 'None').split('(')[0].trim()}</span>
                        </div>
                        <div class="trait-item">
                            <span class="trait-label">Clothes:</span>
                            <span class="${getRarityClass(nft['Clothes'])}">${(nft['Clothes'] || 'None').split('(')[0].trim()}</span>
                        </div>
                        <div class="trait-item">
                            <span class="trait-label">Eyes:</span>
                            <span class="${getRarityClass(nft['Eyes'])}">${(nft['Eyes'] || 'None').split('(')[0].trim()}</span>
                        </div>
                        <div class="trait-item">
                            <span class="trait-label">Eyewear:</span>
                            <span class="${getRarityClass(nft['Eyewear'])}">${(nft['Eyewear'] || 'None').split('(')[0].trim()}</span>
                        </div>
                        <div class="trait-item">
                            <span class="trait-label">Mouth:</span>
                            <span class="${getRarityClass(nft['Mouth Items'])}">${(nft['Mouth Items'] || 'None').split('(')[0].trim()}</span>
                        </div>
                        <div class="owner-section">
                            <button class="fetch-owner-btn" id="fetch-btn-${cardId}" onclick="fetchNFTOwner(${tokenId}, '${cardId}')">
                                Fetch Owner Address
                            </button>
                            <div id="owner-${cardId}"></div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');

            if (shouldScroll) {
                setTimeout(() => {
                    info.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 100);
            }
        }

        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    allNfts = results.data.filter(nft => nft.ID); // Ensure all NFTs have an ID
                    document.getElementById('upload-section').classList.add('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                    document.getElementById('total-count').textContent = `Total: ${allNfts.length} NFTs`;
                    
                    createRarityButtons();
                    populateTraitDropdowns();
                    applyFilters();
                },
                error: function(error) {
                    alert('Error parsing CSV: ' + error.message);
                }
            });
        });
    </script>
</body>
</html>