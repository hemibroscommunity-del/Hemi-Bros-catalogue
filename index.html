<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hemi Bros NFT Gallery</title>
    
    <!-- Google Fonts: VT323 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              'sans': ['ui-sans-serif', 'system-ui', 'sans-serif'],
              'pixel': ['VT323', 'monospace'],
            },
            colors: {
              'snes-purple': '#5850a8',
              'snes-light-gray': '#d1d1d1',
              'snes-panel': '#f0f0f0',
              'snes-dark-gray': '#848484',
              'snes-text-dark': '#2a2a2a',
              'primary': '#5850a8',
              'secondary': '#848484',
              'grail': '#e60012',
              'legendary': '#ff9900',
              'epic': '#b344f3',
              'rare': '#00a800',
              'uncommon': '#a0522d',
              'common': '#6b7280',
            },
            transitionProperty: {
              'width': 'width',
            }
          },
        },
      }
    </script>
    <style type="text/css">
      body {
        font-family: 'ui-sans-serif', 'system-ui', sans-serif;
        background-color: #d1d1d1; /* snes-light-gray */
        background-image: linear-gradient(45deg, #c6c6c6 25%, transparent 25%), linear-gradient(-45deg, #c6c6c6 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #c6c6c6 75%), linear-gradient(-45deg, transparent 75%, #c6c6c6 75%);
        background-size: 8px 8px;
      }
      .font-pixel {
        font-family: "VT323", monospace;
      }
       .retro-button {
        background-color: #848484;
        color: #f0f0f0;
        border: 2px solid #2a2a2a;
        transition: filter 0.1s ease-out;
       }
       .retro-button:hover {
        filter: brightness(1.1);
       }
       .retro-button:active {
        filter: brightness(0.9);
       }
       .retro-button-red {
        background-color: #e60012;
        color: white;
       }
       .retro-button-red:hover {
        background-color: #ff1a2d;
       }
      select {
        appearance: none;
        -webkit-appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23848484' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      @keyframes rare-glow {
          0%, 100% { box-shadow: 0 0 5px #00a800, 0 0 10px #00a800; }
          50% { box-shadow: 0 0 15px #33c333, 0 0 20px #33c333; }
      }
      .animate-rare-glow { animation: rare-glow 2s ease-in-out infinite; }

      @keyframes epic-glow {
        0%, 100% { box-shadow: 0 0 8px #b344f3, 0 0 12px #b344f3, inset 0 0 5px #d27cff; }
        50% { box-shadow: 0 0 16px #c364ff, 0 0 24px #c364ff, inset 0 0 10px #e1a0ff; }
      }
      .animate-epic-glow { animation: epic-glow 1.5s ease-in-out infinite; }

      @keyframes legendary-glow {
        0% { box-shadow: 0 0 10px #ff9900, 0 0 15px #ff9900, 0 0 20px #ff9900; transform: scale(1); }
        50% { box-shadow: 0 0 20px #ffc966, 0 0 30px #ffc966, 0 0 40px #ffc966; transform: scale(1.05); }
        100% { box-shadow: 0 0 10px #ff9900, 0 0 15px #ff9900, 0 0 20px #ff9900; transform: scale(1); }
      }
      .animate-legendary-glow { animation: legendary-glow 1.8s ease-in-out infinite; }

      @keyframes grail-glow {
        0%, 100% { box-shadow: 0 0 15px #e60012, 0 0 25px #ff1a2d, 0 0 35px #ff1a2d; text-shadow: 0 0 5px #fff; }
        50% { box-shadow: 0 0 30px #ff3344, 0 0 50px #ff4d5d, 0 0 70px #ff4d5d; text-shadow: 0 0 10px #fff; }
      }
      .animate-grail-glow { animation: grail-glow 1s linear infinite; }

    </style>
    <script type="importmap">
      {
        "imports": {
          "react": "https://aistudiocdn.com/react@^19.2.0",
          "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
          "react/": "https://aistudiocdn.com/react@^19.2.0/",
          "react-router-dom": "https://aistudiocdn.com/react-router-dom@^7.9.4",
          "papaparse": "https://aistudiocdn.com/papaparse@^5.5.3",
          "@supabase/supabase-js": "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"
        }
      }
    </script>
    <!-- Babel Standalone for in-browser JSX/TS transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="antiasaed text-snes-text-dark">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        // External library imports
        import React, { useState, useEffect, useMemo, useCallback, useRef, forwardRef, memo } from 'react';
        import ReactDOM from 'react-dom/client';
        import { HashRouter, Routes, Route, NavLink } from 'react-router-dom';
        import Papa from 'papaparse';
        import { createClient } from '@supabase/supabase-js';

        // --- All application code is consolidated below ---

        // --- From components/Icons.tsx ---
        const BroTypeIcon = ({ className = 'h-4 w-4' }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 20 20" fill="currentColor">
              <path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd" />
            </svg>
        );
        const ClothesIcon = ({ className = 'h-4 w-4' }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 20 20" fill="currentColor">
              <path d="M5.5 3.5A2.5 2.5 0 018 1h4a2.5 2.5 0 012.5 2.5V5h-9V3.5zM3 6h14v10a2 2 0 01-2 2H5a2 2 0 01-2-2V6z" />
            </svg>
        );
        const EyewearIcon = ({ className = 'h-4 w-4' }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M4.68 10.98a5 5 0 019.64 0M19.32 10.98a5 5 0 01-9.64 0M4 11h16" />
            </svg>
        );
        const EyesIcon = ({ className = 'h-4 w-4' }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 20 20" fill="currentColor">
              <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
              <path fillRule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.03 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clipRule="evenodd" />
            </svg>
        );
        const HeadwearIcon = ({ className = 'h-4 w-4' }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 20 20" fill="currentColor">
              <path d="M10 2a5 5 0 00-5 5v1h10V7a5 5 0 00-5-5zM3 9v5a2 2 0 002 2h10a2 2 0 002-2V9a1 1 0 10-2 0v5H5V9a1 1 0 10-2 0z" />
            </svg>
        );
        const MouthItemsIcon = ({ className = 'h-4 w-4' }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M6 15c1.5-2 4.5-3 6-3s4.5 1 6 3" />
            </svg>
        );
        const CloseIcon = ({ className = "h-6 w-6" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
        );
        const SlidersIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
            </svg>
        );
        const IdIcon = ({ className = 'h-4 w-4' }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
            </svg>
        );
        const InfoIcon = ({ className = 'h-5 w-5' }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );
        const StarIcon = ({ className = "h-6 w-6" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}>
                <path fillRule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.007z" clipRule="evenodd" />
            </svg>
        );
        const WarningIcon = ({ className = 'h-4 w-4' }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 13a1 1 0 100-2 1 1 0 000 2zm-1-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clipRule="evenodd" />
            </svg>
        );


        // --- From constants.tsx ---
        const RARITY_LEVELS = ['Grail', 'Legendary', 'Epic', 'Rare', 'Uncommon', 'Common'];
        const TRAIT_MAP = {
          'Bro Type': 'Bro Type',
          'Headwear': 'Headwear',
          'Clothes': 'Clothes',
          'Eyes': 'Eyes',
          'Eyewear': 'Eyewear',
          'Mouth Items': 'Mouth Items',
        };
        const TRAIT_CATEGORIES = [...Object.keys(TRAIT_MAP), 'Background'];
        const TRAIT_ICONS = {
          'Bro Type': BroTypeIcon,
          'Headwear': HeadwearIcon,
          'Clothes': ClothesIcon,
          'Eyes': EyesIcon,
          'Eyewear': EyewearIcon,
          'Mouth Items': MouthItemsIcon,
        };
        const RARITY_LEGEND_DATA = [
          { tier: 'Grail', stars: 6, supplyRange: '1', colorClass: 'text-grail' },
          { tier: 'Legendary', stars: 5, supplyRange: '2-10', colorClass: 'text-legendary' },
          { tier: 'Epic', stars: 4, supplyRange: '11-25', colorClass: 'text-epic' },
          { tier: 'Rare', stars: 3, supplyRange: '26-50', colorClass: 'text-rare' },
          { tier: 'Uncommon', stars: 2, supplyRange: '51-100', colorClass: 'text-uncommon' },
          { tier: 'Common', stars: 1, supplyRange: '101+', colorClass: 'text-common' },
        ];
        const HEMI_EXPLORER_API = 'https://explorer.hemi.xyz/api/v2';
        const CONTRACT_ADDRESS = '0xEAB71F90235E6b885C05aFFF3BAF0E41244cf874';


        // --- From utils.ts ---
        const createTraitNameKey = (name) => {
          if (!name || name === 'None') return 'none';
          return name.split(' (')[0].trim().toLowerCase();
        };
        const createTraitKey = (type, name) => {
          const normalizedName = createTraitNameKey(name);
          const normalizedType = type.trim().toLowerCase();
          return `${normalizedType}:${normalizedName}`;
        };
        function getRarityInfoFromSupply(supply) {
          if (isNaN(supply)) return { tier: 'Common', className: 'text-common' };
          if (supply === 1) return { tier: 'Grail', className: 'text-grail' };
          if (supply <= 10) return { tier: 'Legendary', className: 'text-legendary' };
          if (supply <= 25) return { tier: 'Epic', className: 'text-epic' };
          if (supply <= 50) return { tier: 'Rare', className: 'text-rare' };
          if (supply <= 100) return { tier: 'Uncommon', className: 'text-uncommon' };
          return { tier: 'Common', className: 'text-common' };
        }
        function getRarityInfoFromTrait(traitValue) {
          if (!traitValue) return { tier: 'N/A', className: 'text-gray-400' };
          const match = traitValue.toString().match(/\((\d+)\)/);
          if (!match) return { tier: 'Common', className: 'text-common' };
          const supply = parseInt(match[1], 10);
          return getRarityInfoFromSupply(supply);
        }
        function getBestRarity(nft) {
          let lowestSupply = Infinity;
          let sourceTrait = 'N/A';
          TRAIT_CATEGORIES.forEach(traitKey => {
            const traitValue = nft[traitKey];
            const match = traitValue?.toString().match(/\((\d+)\)/);
            if (match) {
              const currentSupply = parseInt(match[1], 10);
              if (currentSupply < lowestSupply) {
                lowestSupply = currentSupply;
                sourceTrait = TRAIT_MAP[traitKey] || traitKey;
              }
            }
          });
          if (lowestSupply === Infinity) {
            return { tier: 'Common', className: 'text-common', sourceTrait: 'N/A' };
          }
          const rarityInfo = getRarityInfoFromSupply(lowestSupply);
          return { ...rarityInfo, sourceTrait };
        }
        function getBestItemRarity(nft) {
            let lowestSupply = Infinity;
            let sourceTrait = 'N/A';
            const itemTraits = TRAIT_CATEGORIES.filter(t => t !== 'Bro Type');
            itemTraits.forEach(traitKey => {
              const traitValue = nft[traitKey];
              const match = traitValue?.toString().match(/\((\d+)\)/);
              if (match) {
                const currentSupply = parseInt(match[1], 10);
                if (currentSupply < lowestSupply) {
                  lowestSupply = currentSupply;
                  sourceTrait = TRAIT_MAP[traitKey] || traitKey;
                }
              }
            });
            if (lowestSupply === Infinity) {
                return { tier: 'N/A', className: 'text-gray-400', sourceTrait: 'N/A' };
            }
            const rarityInfo = getRarityInfoFromSupply(lowestSupply);
            return { ...rarityInfo, sourceTrait };
        }
        function getRarityClass(traitValue) {
          return getRarityInfoFromTrait(traitValue).className;
        }
        const timeUnits = [
            { unit: 'year', seconds: 31536000 },
            { unit: 'month', seconds: 2592000 },
            { unit: 'week', seconds: 604800 },
            { unit: 'day', seconds: 86400 },
            { unit: 'hour', seconds: 3600 },
            { unit: 'minute', seconds: 60 },
            { unit: 'second', seconds: 1 },
        ];
        const rtf = new Intl.RelativeTimeFormat('en', { numeric: 'auto' });
        function formatTimestamp(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const seconds = Math.floor((now.getTime() - date.getTime()) / 1000);
            for (const { unit, seconds: unitSeconds } of timeUnits) {
              const interval = Math.floor(seconds / unitSeconds);
              if (interval >= 1) {
                return rtf.format(-interval, unit);
              }
            }
            return 'just now';
        }

        // --- From components/Rarity.tsx ---
        const RarityStarsDisplay = ({ tier, className = 'h-5 w-5' }) => {
          let stars = 0;
          let colorClass = 'text-gray-400';
          switch (tier) {
            case 'Grail': stars = 6; colorClass = 'text-grail'; break;
            case 'Legendary': stars = 5; colorClass = 'text-legendary'; break;
            case 'Epic': stars = 4; colorClass = 'text-epic'; break;
            case 'Rare': stars = 3; colorClass = 'text-rare'; break;
            case 'Uncommon': stars = 2; colorClass = 'text-uncommon'; break;
            case 'Common': stars = 1; colorClass = 'text-common'; break;
          }
          if (stars === 0) return null;
          return (
            <div className="flex items-center">
              {Array.from({ length: stars }).map((_, i) => (
                <StarIcon key={i} className={`${className} ${colorClass}`} />
              ))}
            </div>
          );
        };
        const RarityBadge = ({tier}) => {
            let stars = 0;
            let containerClasses = 'relative flex items-center gap-1 text-xs font-bold text-white px-2 py-0.5 rounded-full whitespace-nowrap transition-all duration-300 flex-shrink-0';
            switch (tier) {
              case 'Grail': stars = 6; containerClasses += ' bg-grail'; break;
              case 'Legendary': stars = 5; containerClasses += ' bg-legendary'; break;
              case 'Epic': stars = 4; containerClasses += ' bg-epic'; break;
              case 'Rare': stars = 3; containerClasses += ' bg-rare'; break;
              case 'Uncommon': stars = 2; containerClasses += ' bg-uncommon'; break;
              case 'Common': stars = 1; containerClasses += ' bg-common'; break;
              default: stars = 0; containerClasses += ' bg-gray-400'; break;
            }
            return (
              <div className={containerClasses}>
                  <div className="relative z-10 flex items-center gap-1">
                      {Array.from({ length: stars }).map((_, i) => <StarIcon key={i} className="h-3 w-3" />)}
                      <span>{tier}</span>
                  </div>
              </div>
            );
        };
        const RarityInfoBlock = ({ title, tier, source, className = '' }) => {
            const rarityStyles = {
                Grail: 'bg-grail/10 border-grail text-grail',
                Legendary: 'bg-legendary/10 border-legendary text-legendary',
                Epic: 'bg-epic/10 border-epic text-epic',
                Rare: 'bg-rare/10 border-rare text-rare',
                Uncommon: 'bg-uncommon/10 border-uncommon text-uncommon',
                Common: 'bg-common/10 border-common text-common',
                'N/A': 'bg-gray-400/10 border-gray-400 text-gray-400'
            };
            const style = rarityStyles[tier] || rarityStyles['N/A'];
            const fullTitle = source ? `${title} (from ${source})` : title;
            return (
                <div className={`p-2 rounded-lg border-l-4 ${style} ${className}`}>
                    <p className="text-sm font-semibold text-gray-600">{fullTitle}</p>
                    <div className="flex justify-between items-center mt-1">
                        <p className={`text-lg font-bold`}>{tier}</p>
                        <RarityStarsDisplay tier={tier} />
                    </div>
                </div>
            );
        };

        // --- From components/Modals.tsx ---
        const SUPABASE_URL = 'https://bmopbmxhckzekvpslfde.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtb3BibXhoY2t6ZWt2cHNsZmRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NTMyMjIsImV4cCI6MjA3NjAyOTIyMn0.OvLCYaYRqB11VSiegvOE-7XcMAtVnVzjLP5RqPE-Wno';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const ImageModal = ({ imageUrl, onClose }) => {
            if (!imageUrl) return null;
            return (
                <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4" onClick={onClose} aria-modal="true" role="dialog">
                    <button onClick={onClose} className="absolute top-4 right-4 p-2 text-white rounded-full hover:bg-white/20 transition-colors" aria-label="Close image view"><CloseIcon className="h-8 w-8" /></button>
                    <div className="relative" onClick={e => e.stopPropagation()}>
                        <img src={imageUrl} alt="Enlarged NFT" className="max-w-[90vw] max-h-[90vh] object-contain rounded-lg shadow-2xl" />
                    </div>
                </div>
            );
        };
        const TraitDetailModal = ({ trait, onClose }) => {
            if (!trait) return null;
            const Icon = TRAIT_ICONS[trait['Trait Type']];
            const supply = parseInt(trait.Supply, 10);
            const rarityInfo = getRarityInfoFromTrait(`${trait['Unique Item List']} (${supply})`);
            const legendData = RARITY_LEGEND_DATA.find(r => r.tier === rarityInfo.tier);
            return (
                <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4" onClick={onClose} aria-modal="true" role="dialog">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm relative" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-3 right-3 p-2 rounded-full hover:bg-gray-200 transition-colors z-10" aria-label="Close trait details"><CloseIcon /></button>
                        <div className="p-6 pt-10">
                            {legendData && (
                                <div className="flex justify-between items-center bg-gray-100 p-2 rounded-md mb-4 text-sm">
                                    <div className="flex items-center gap-2 flex-wrap">
                                        <span className={`font-bold ${rarityInfo.className}`}>{rarityInfo.tier}</span>
                                        <RarityStarsDisplay tier={rarityInfo.tier} className="h-4 w-4" />
                                        <span className="text-gray-500 font-medium whitespace-nowrap">(Supply: {legendData.supplyRange})</span>
                                    </div>
                                    <span className="font-semibold text-gray-600 ml-2">Supply: <span className="font-bold text-gray-800">{trait.Supply}</span></span>
                                </div>
                            )}
                            <div className="flex items-center gap-3 mb-3">
                                {Icon && <div className="p-2 bg-gray-100 rounded-md"><Icon className="h-6 w-6 text-primary" /></div>}
                                <div>
                                    <p className="text-xs text-gray-500">{trait['Trait Type']}</p>
                                    <p className={`font-semibold text-lg ${rarityInfo.className}`}>{trait['Unique Item List']}</p>
                                </div>
                            </div>
                            <h3 className={`text-xl font-bold text-center mb-2 ${rarityInfo.className}`}>{`"${trait.Title || "No Title"}"`}</h3>
                            <p className="text-sm text-gray-700">{trait.Description || "No description available."}</p>
                        </div>
                    </div>
                </div>
            );
        };
        const TraitItem = ({ label, value, icon: Icon, onClick, hasDetails, isIpRisk }) => (
            <button onClick={onClick} disabled={!hasDetails} className={`bg-gray-100 p-2 rounded-md text-left w-full transition-all duration-200 ${hasDetails ? 'hover:bg-primary/10 hover:shadow-md cursor-pointer' : 'opacity-70 cursor-not-allowed'}`}>
                <div className="flex items-center gap-2 mb-1">
                    {Icon && <Icon className="h-4 w-4 text-gray-500" />}
                    <p className="text-xs font-semibold text-gray-500 uppercase">{label}</p>
                </div>
                <div className="flex items-center justify-between min-w-0">
                    <p className={`font-medium ${getRarityClass(value)} truncate`}>{value?.split(' (')[0].trim() || 'None'}</p>
                    {isIpRisk && (
                        <div className="relative group flex-shrink-0 ml-1">
                            <WarningIcon className="h-5 w-5 text-yellow-500" />
                            <span className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max px-2 py-1 bg-gray-800 text-white text-xs rounded-md opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                Potential IP Risk
                            </span>
                        </div>
                    )}
                </div>
            </button>
        );
        const NftModal = ({ nft, onClose, traitDetails, onTraitClick, onImageClick, onMakeOffer }) => {
            if (!nft) return null;
            const broTypeRarity = getRarityInfoFromTrait(nft['Bro Type']);
            const bestItemRarity = getBestItemRarity(nft);
            const showBestItemRarity = bestItemRarity.tier !== 'N/A' && bestItemRarity.tier !== 'Common';
            const imageUrl = nft.Image || `https://picsum.photos/seed/${nft.ID}/500`;
            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm max-h-[90vh] overflow-y-auto flex flex-col" onClick={e => e.stopPropagation()}>
                        <div className="p-3 flex justify-between items-center border-b sticky top-0 bg-white z-10">
                            <h2 className="text-lg font-bold text-primary">Hemi Bro #{nft.ID}</h2>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-200"><CloseIcon /></button>
                        </div>
                        <div className="p-3 space-y-2">
                            <div className="flex justify-center">
                                <img src={imageUrl} alt={`Hemi Bro #${nft.ID}`} className="w-32 h-32 rounded-lg shadow-lg cursor-pointer hover:scale-105 transition-transform duration-200" onClick={() => onImageClick(imageUrl)} />
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-1.5">
                                <RarityInfoBlock title="Bro Type Rarity" tier={broTypeRarity.tier} className={!showBestItemRarity ? 'sm:col-span-2' : ''} />
                                {showBestItemRarity && <RarityInfoBlock title="Best Item Rarity" tier={bestItemRarity.tier} source={bestItemRarity.sourceTrait} />}
                            </div>
                            <div className="border-t border-gray-200"></div>
                            <div className="grid grid-cols-2 gap-1.5">
                                {Object.entries(TRAIT_MAP).map(([key, label]) => {
                                    const traitValue = nft[key];
                                    const details = Object.values(traitDetails).find(d => createTraitKey(d["Trait Type"], d["Unique Item List"]) === createTraitKey(key, traitValue));
                                    const isIpRisk = details?.['IP Concern']?.trim() === 'Yes';
                                    return (
                                        <TraitItem
                                            key={key}
                                            label={label}
                                            value={traitValue}
                                            icon={TRAIT_ICONS[label]}
                                            onClick={() => details && onTraitClick(details)}
                                            hasDetails={!!details}
                                            isIpRisk={isIpRisk}
                                        />
                                    );
                                })}
                            </div>
                        </div>
                        <div className="p-4 border-t sticky bottom-0 bg-white z-10">
                            <button onClick={() => onMakeOffer(nft)} className="w-full retro-button bg-snes-purple text-white font-bold py-2 px-4 rounded-lg hover:bg-opacity-90 transition-colors">
                                Make an Offer
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        const OfferModal = ({ nft, onClose }) => {
            const [amount, setAmount] = useState('');
            const [walletAddress, setWalletAddress] = useState('');
            const [message, setMessage] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [submissionError, setSubmissionError] = useState(null);
            const handleSubmit = async (e) => {
                e.preventDefault();
                setSubmissionError(null);
                if (!amount || isNaN(parseFloat(amount)) || parseFloat(amount) <= 0) {
                    setSubmissionError('Please enter a valid offer amount.');
                    return;
                }
                if (!walletAddress.match(/^0x[a-fA-F0-9]{40}$/)) {
                    setSubmissionError('Please enter a valid Ethereum wallet address (e.g., 0x...).');
                    return;
                }
                setIsSubmitting(true);
                const { error } = await supabase
                    .from('offers')
                    .insert({ 
                        nft_id: nft.ID.toString(),
                        wallet_address: walletAddress,
                        offer_amount: parseFloat(amount),
                        message: message || null
                    });
                setIsSubmitting(false);
                if (error) {
                    console.error('Supabase error:', error);
                    const errorMessage = (error && typeof error.message === 'string') 
                        ? error.message 
                        : 'An unexpected error occurred. Please check the console for details.';
                    setSubmissionError(`Failed to submit offer: ${errorMessage}`);
                } else {
                    alert(`Your offer for Hemi Bro #${nft.ID} has been successfully recorded!`);
                    onClose();
                }
            };
            if (!nft) return null;
            return (
                <div className="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 relative" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} disabled={isSubmitting} className="absolute top-3 right-3 p-2 rounded-full hover:bg-gray-200" aria-label="Close offer form"><CloseIcon /></button>
                        <h3 className="text-lg font-bold text-snes-text-dark mb-4">Make an Offer for NFT #{nft.ID}</h3>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label htmlFor="wallet-address" className="block text-sm font-medium text-gray-700">Your Wallet Address</label>
                                <input type="text" id="wallet-address" value={walletAddress} onChange={e => setWalletAddress(e.target.value)} placeholder="0x..." className="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary" required disabled={isSubmitting} />
                            </div>
                            <div>
                                <label htmlFor="offer-amount" className="block text-sm font-medium text-gray-700">Offer Amount (e.g., in ETH)</label>
                                <input type="number" id="offer-amount" value={amount} onChange={e => setAmount(e.target.value)} placeholder="0.1" step="0.01" min="0" className="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary" required disabled={isSubmitting} />
                            </div>
                            <div>
                                <label htmlFor="offer-message" className="block text-sm font-medium text-gray-700">Message (Optional)</label>
                                <textarea id="offer-message" rows={3} value={message} onChange={e => setMessage(e.target.value)} placeholder="I love this Hemi Bro!" className="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary" disabled={isSubmitting}></textarea>
                            </div>
                            {submissionError && (
                                <p className="text-sm text-red-600 bg-red-100 p-2 rounded-md">{submissionError}</p>
                            )}
                            <div className="flex justify-end gap-3 pt-2">
                                <button type="button" onClick={onClose} className="retro-button px-4 py-2 text-sm rounded-md" disabled={isSubmitting}>Cancel</button>
                                <button type="submit" className="retro-button retro-button-red px-4 py-2 text-sm rounded-md disabled:bg-gray-400 disabled:cursor-not-allowed" disabled={isSubmitting}>
                                    {isSubmitting ? 'Submitting...' : 'Submit Offer'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };
        const AllOffersModal = ({ isOpen, onClose, nfts }) => {
            const [offers, setOffers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const nftMap = useMemo(() => {
                return nfts.reduce((acc, nft) => {
                    acc[nft.ID] = nft;
                    return acc;
                }, {});
            }, [nfts]);
            useEffect(() => {
                if (isOpen) {
                    const fetchOffers = async () => {
                        setLoading(true);
                        setError(null);
                        const { data, error } = await supabase
                            .from('offers')
                            .select('*')
                            .order('created_at', { ascending: false });
                        if (error) {
                            console.error('Error fetching all offers:', error);
                            setError(JSON.stringify(error, null, 2));
                        } else {
                            setOffers(data || []);
                        }
                        setLoading(false);
                    };
                    fetchOffers();
                }
            }, [isOpen]);
            if (!isOpen) return null;
            const renderContent = () => {
                if (loading) {
                    return <div className="text-center p-8">Loading offers...</div>;
                }
                if (error) {
                    return (
                        <div className="text-left p-3 bg-red-50 text-red-800 rounded-lg">
                            <p className="font-semibold mb-2">An error occurred while fetching offers:</p>
                            <pre className="text-xs whitespace-pre-wrap break-all bg-red-100 p-2 rounded">{error}</pre>
                        </div>
                    );
                }
                if (offers.length === 0) {
                    return <div className="text-center p-8 text-gray-500">No offers have been submitted yet.</div>;
                }
                return (
                    <ul className="space-y-3">
                        {offers.map(offer => {
                            const nft = nftMap[offer.nft_id];
                            const imageUrl = nft?.Image;
                            return (
                                <li key={offer.id} className="bg-gray-50 p-3 rounded-lg border">
                                    <div className="flex justify-between items-start">
                                        <div className="flex items-center gap-3 min-w-0">
                                            {imageUrl && (
                                                <img 
                                                    src={imageUrl} 
                                                    alt={`NFT #${offer.nft_id}`}
                                                    className="w-12 h-12 rounded-md object-cover border-2 border-gray-200 flex-shrink-0"
                                                    loading="lazy"
                                                />
                                            )}
                                            <div className="min-w-0">
                                                <p className="font-bold text-primary truncate">Offer on NFT #{offer.nft_id}</p>
                                                <p className="text-sm font-semibold">{offer.offer_amount} ETH</p>
                                            </div>
                                        </div>
                                        <p className="text-xs text-gray-500 flex-shrink-0 ml-2">{formatTimestamp(offer.created_at)}</p>
                                    </div>
                                    {offer.message && <p className="text-sm text-gray-600 mt-2 p-2 bg-gray-100 rounded">"{offer.message}"</p>}
                                    <p className="text-xs text-gray-400 mt-2 truncate">From: {offer.wallet_address}</p>
                                </li>
                            );
                        })}
                    </ul>
                );
            };
            return (
                <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4" onClick={onClose} aria-modal="true" role="dialog">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                        <div className="p-4 flex justify-between items-center border-b sticky top-0 bg-white">
                            <h3 className="text-lg font-bold text-snes-text-dark">All Submitted Offers</h3>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-200" aria-label="Close offers view"><CloseIcon /></button>
                        </div>
                        <div className="p-4 overflow-y-auto">
                            {renderContent()}
                        </div>
                    </div>
                </div>
            );
        };


        // --- From hooks/useNfts.ts ---
        const useNfts = () => {
          const [nfts, setNfts] = useState([]);
          const [traitDetails, setTraitDetails] = useState({});
          const [loading, setLoading] = useState(true);
          const [error, setError] = useState(null);
          const [filters, setFilters] = useState({
            id: '',
            owner: '',
            rarity: '',
            traits: {},
            ownerFilteredIds: null,
          });
          const [isOwnerSearching, setIsOwnerSearching] = useState(false);
          const [ownerSearchError, setOwnerSearchError] = useState(null);
          const [showIpConcern, setShowIpConcern] = useState(false);
          const searchByOwner = useCallback(async (searchAddress) => {
            if (!searchAddress.match(/^0x[a-fA-F0-9]{40}$/)) {
                setOwnerSearchError('Invalid Ethereum address format.');
                return;
            }
            setIsOwnerSearching(true);
            setOwnerSearchError(null);
            try {
                let allItems = [];
                let nextPageParams = null;
                do {
                    let originalUrl = `${HEMI_EXPLORER_API}/tokens/${CONTRACT_ADDRESS}/instances?holder_address_hash=${searchAddress}`;
                    if (nextPageParams) {
                        const paramString = Object.entries(nextPageParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
                        originalUrl += `&${paramString}`;
                    }
                    const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(originalUrl)}`;
                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                    const data = await response.json();
                    if (data.items && data.items.length > 0) {
                        allItems = allItems.concat(data.items);
                    }
                    nextPageParams = data.next_page_params;
                } while (nextPageParams);
                const ownedTokenIds = new Set(allItems.map(item => item.id.toString()));
                setFilters({ id: '', rarity: '', traits: {}, owner: searchAddress, ownerFilteredIds: ownedTokenIds });
            } catch (error) {
                console.error('Error fetching from Hemi Explorer:', error);
                setOwnerSearchError(error.message || 'Could not fetch owner data.');
                setFilters(prev => ({ ...prev, owner: '', ownerFilteredIds: null }));
            } finally {
                setIsOwnerSearching(false);
            }
          }, []);
          useEffect(() => {
            const fetchAllData = async () => {
              setLoading(true);
              setError(null);
              try {
                const [nftResponse, traitResponse] = await Promise.all([
                  fetch('https://raw.githubusercontent.com/hemibroscommunity-del/Hemi-Bros-catalogue/main/justCSVdata.txt'),
                  fetch('https://raw.githubusercontent.com/hemibroscommunity-del/Hemi-Bros-catalogue/main/All%20Hemi%20Bros%20NFT%20Rarity%20-%20convertcsv1%20-%20SupplyCount%20-%20descriptions%20and%20flags.txt'),
                ]);
                if (!nftResponse.ok) throw new Error(`Failed to fetch NFT data: ${nftResponse.statusText}`);
                if (!traitResponse.ok) throw new Error(`Failed to fetch Trait data: ${traitResponse.statusText}`);
                const nftCsvText = await nftResponse.text();
                const traitCsvText = await traitResponse.text();
                const nameDetailsPromise = new Promise((resolve, reject) => {
                    Papa.parse(traitCsvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            if (results.errors.length) return reject(new Error("Failed to parse Trait details CSV."));
                            const map = results.data.reduce((acc, detail) => {
                                const traitName = detail['Unique Item List'];
                                if (traitName) {
                                    const key = traitName.trim().toLowerCase();
                                    acc[key] = detail;
                                }
                                return acc;
                            }, {});
                            resolve(map);
                        },
                        error: (err) => reject(err)
                    });
                });
                const nftsPromise = new Promise((resolve, reject) => {
                    Papa.parse(nftCsvText, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            if (results.errors.length) return reject(new Error("Failed to parse NFT data CSV."));
                            resolve(results.data.filter(nft => nft.ID != null));
                        },
                        error: (err) => reject(err)
                    });
                });
                const [nameDetailsMap, parsedNfts] = await Promise.all([nameDetailsPromise, nftsPromise]);
                const nameToTypeMap = {};
                parsedNfts.forEach(nft => {
                    TRAIT_CATEGORIES.forEach(category => {
                        const traitValue = nft[category];
                        const nameKey = createTraitNameKey(traitValue);
                        if (nameKey !== 'none' && !nameToTypeMap[nameKey]) {
                            nameToTypeMap[nameKey] = category;
                        }
                    });
                });
                const finalTraitDetailsMap = {};
                for(const nameKey in nameDetailsMap) {
                    const type = nameToTypeMap[nameKey];
                    if (type) {
                        const traitKey = `${type.trim().toLowerCase()}:${nameKey}`;
                        finalTraitDetailsMap[traitKey] = {
                            ...nameDetailsMap[nameKey],
                            'Trait Type': type,
                        };
                    }
                }
                const ipConcernTraitKeys = new Set(Object.values(finalTraitDetailsMap)
                    .filter(d => d['IP Concern']?.trim() === 'Yes')
                    .map(d => createTraitKey(d['Trait Type'], d['Unique Item List']))
                );
                const nftsWithFlags = parsedNfts.map(nft => {
                    const hasIpConcern = TRAIT_CATEGORIES.some(traitKey => {
                        const traitValue = nft[traitKey];
                        const key = createTraitKey(traitKey, traitValue);
                        return ipConcernTraitKeys.has(key);
                    });
                    return { ...nft, isIpConcern: hasIpConcern };
                });
                setTraitDetails(finalTraitDetailsMap);
                setNfts(nftsWithFlags);
              } catch (e) {
                console.error("Fetching data failed:", e);
                setError(e.message || "An unknown error occurred while fetching data.");
              } finally {
                setLoading(false);
              }
            };
            fetchAllData();
          }, []);
          const preIpFilteredNfts = useMemo(() => {
            let baseNfts = nfts;
            if (filters.ownerFilteredIds) {
              baseNfts = nfts.filter(nft => filters.ownerFilteredIds.has(nft.ID.toString()));
            }
            return baseNfts.filter(nft => {
              const idMatch = filters.id ? nft.ID.toString() === filters.id : true;
              const rarityMatch = filters.rarity ? getBestRarity(nft).tier === filters.rarity : true;
              const traitsMatch = Object.entries(filters.traits).every(([trait, value]) => {
                  const nftTraitValue = nft[trait];
                  return nftTraitValue === value;
              });
              return idMatch && rarityMatch && traitsMatch;
            });
          }, [nfts, filters]);
          const filteredNfts = useMemo(() => {
            if (showIpConcern) {
              return preIpFilteredNfts;
            }
            return preIpFilteredNfts.filter(nft => !nft.isIpConcern);
          }, [preIpFilteredNfts, showIpConcern]);
          const hasHiddenIpRiskItems = useMemo(() => {
            if (!showIpConcern && (filters.id || filters.owner)) {
                return preIpFilteredNfts.some(nft => nft.isIpConcern);
            }
            return false;
          }, [filters.id, filters.owner, showIpConcern, preIpFilteredNfts]);
          const traitOptions = useMemo(() => {
            const options = {};
            TRAIT_CATEGORIES.filter(c => c !== 'Background').forEach(traitKey => {
              const traitValues = new Set();
              nfts.forEach(nft => {
                const value = nft[traitKey];
                if (value) traitValues.add(value);
              });
              options[traitKey] = Array.from(traitValues).sort();
            });
            return options;
          }, [nfts]);
          return { nfts, filteredNfts, filters, setFilters, traitOptions, loading, error, showIpConcern, setShowIpConcern, traitDetails, searchByOwner, isOwnerSearching, ownerSearchError, hasHiddenIpRiskItems };
        };

        // --- From components/NftCard.tsx ---
        const NftCard = forwardRef(({ nft, onCardClick, isSidebarOpen }, ref) => {
          const bestRarity = getBestRarity(nft);
          const broTypeRarity = getRarityInfoFromTrait(nft['Bro Type']);
          const glowClasses = {
            'Grail': 'animate-grail-glow',
            'Legendary': 'animate-legendary-glow',
            'Epic': 'animate-epic-glow',
            'Rare': 'animate-rare-glow',
          };
          const cardClasses = `bg-white rounded-lg shadow-md overflow-hidden cursor-pointer transform hover:scale-105 hover:shadow-xl transition-all duration-200 group flex flex-col border ${glowClasses[broTypeRarity.tier] || ''}`;
          return (
            <div ref={ref} className={cardClasses} onClick={() => onCardClick(nft)}>
              <div className="aspect-w-1 aspect-h-1 w-full">
                <img
                  src={nft.Image || `https://picsum.photos/seed/${nft.ID}/300`}
                  alt={`Hemi Bro #${nft.ID}`}
                  className="object-cover w-full h-full"
                  loading="lazy"
                />
              </div>
              {!isSidebarOpen && (
                <div className="p-2 flex-grow flex flex-col justify-center">
                    <div className="flex justify-between items-center gap-2">
                        <p className="text-sm font-bold text-gray-800 group-hover:text-primary transition-colors truncate min-w-0">#{nft.ID}</p>
                        <RarityBadge tier={bestRarity.tier} />
                    </div>
                </div>
              )}
            </div>
          );
        });
        NftCard.displayName = 'NftCard';
        const MemoizedNftCard = memo(NftCard);

        // --- From components/ActiveFilters.tsx ---
        const FilterTag = ({ label, onRemove }) => (
          <span className="flex items-center bg-primary text-white text-sm font-medium pl-3 pr-2 py-1 rounded-full">
            {label}
            <button onClick={onRemove} className="ml-2 p-0.5 rounded-full hover:bg-white/20 transition-colors" aria-label={`Remove filter: ${label}`}>
              <CloseIcon className="h-3 w-3" />
            </button>
          </span>
        );
        const ActiveFilters = ({ filters, setFilters }) => {
          const activeFilterList = [];
          const handleRemoveId = () => setFilters(prev => ({ ...prev, id: '' }));
          const handleRemoveRarity = () => setFilters(prev => ({ ...prev, rarity: '' }));
          const handleRemoveOwner = () => setFilters(prev => ({ ...prev, owner: '', ownerFilteredIds: null }));
          const handleRemoveTrait = (traitName) => setFilters(prev => {
            const newTraits = { ...prev.traits };
            delete newTraits[traitName];
            return { ...prev, traits: newTraits };
          });
          const handleClearAll = () => setFilters({ id: '', owner: '', rarity: '', traits: {}, ownerFilteredIds: null });
          if (filters.id) activeFilterList.push(<FilterTag key="id" label={`ID: ${filters.id}`} onRemove={handleRemoveId} />);
          if (filters.owner) {
            const address = filters.owner;
            const displayAddress = `${address.slice(0, 6)}...${address.slice(-4)}`;
            activeFilterList.push(<FilterTag key="owner" label={`Owner: ${displayAddress}`} onRemove={handleRemoveOwner} />);
          }
          if (filters.rarity) activeFilterList.push(<FilterTag key="rarity" label={`Rarity: ${filters.rarity}`} onRemove={handleRemoveRarity} />);
          Object.entries(filters.traits).forEach(([traitName, value]) => {
            const displayValue = value.split(' (')[0];
            activeFilterList.push(<FilterTag key={traitName} label={`${traitName}: ${displayValue}`} onRemove={() => handleRemoveTrait(traitName)} />);
          });
          if (activeFilterList.length === 0) return null;
          return (
            <div className="mb-4 p-3 bg-gray-200 rounded-lg flex items-center flex-wrap gap-2 text-gray-800">
              <span className="font-semibold text-sm mr-2">Active Filters:</span>
              {activeFilterList}
              <button onClick={handleClearAll} className="ml-auto py-1 px-3 bg-red-500 text-white text-xs font-bold rounded-full hover:bg-red-600 transition-colors">
                Clear All
              </button>
            </div>
          );
        };
        const MemoizedActiveFilters = memo(ActiveFilters);
        
        // --- From components/FilterSidebar.tsx ---
        const RarityLegend = () => (
            <div>
                <h3 className="text-sm font-semibold text-gray-800 mb-2 text-center">Rarity Legend</h3>
                <div className="space-y-1.5">
                    {RARITY_LEGEND_DATA.map(({ tier, stars, supplyRange, colorClass }) => (
                        <div key={tier} className="flex items-center justify-between text-xs">
                            <div className="flex items-center gap-2">
                                <span className={`font-bold w-20 ${colorClass}`}>{tier}</span>
                                <div className="flex">
                                    {Array.from({ length: stars }).map((_, i) => <StarIcon key={i} className={`h-3 w-3 ${colorClass}`} />)}
                                </div>
                            </div>
                            <span className="text-gray-500 font-medium">Supply: {supplyRange}</span>
                        </div>
                    ))}
                </div>
                <hr className="my-4 border-gray-200" />
                <p className="text-xs text-gray-600 text-center italic">Note: The glowing effect on a card is determined by its <span className="font-semibold">'Bro Type'</span> rarity.</p>
            </div>
        );
        const MemoizedRarityLegend = memo(RarityLegend);
        const RarityLegendModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4" onClick={onClose} aria-modal="true" role="dialog">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 relative" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-3 right-3 p-2 rounded-full hover:bg-gray-200 transition-colors" aria-label="Close rarity legend"><CloseIcon /></button>
                        <MemoizedRarityLegend />
                    </div>
                </div>
            );
        };
        const IpDisclaimerModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4" onClick={onClose} aria-modal="true" role="dialog">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 relative" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-3 right-3 p-2 rounded-full hover:bg-gray-200 transition-colors" aria-label="Close disclaimer"><CloseIcon /></button>
                        <h3 className="text-lg font-bold text-snes-text-dark mb-4">Disclaimer: Collection Display and Flagged Assets</h3>
                        <div className="space-y-3 text-sm text-snes-text-dark">
                            <p>This catalog is designed to display and organize the assets of this NFT collection. However, a number of assets have been identified through public community discussion as containing elements that may pose a risk of intellectual property (IP) infringement.</p>
                            <p><span className="font-semibold">Our Default View:</span> To ensure a straightforward browsing experience and to acknowledge potential marketplace listing challenges, these community-flagged assets are hidden by default in our catalog. This is not a permanent removal, but a default filter setting.</p>
                            <p><span className="font-semibold">User Discretion:</span> All users have the ability to disable this filter and view the complete, unfiltered collection. By choosing to display these assets, you acknowledge that you understand the potential risks associated with them.</p>
                            <p className="italic text-xs text-gray-600 mt-2">The "IP Risk" designation is based on publicly available community feedback and is not a definitive legal judgment made by this platform. We strongly encourage all users to do their own research (DYOR) before buying, selling, or trading any NFT. This information does not constitute legal or financial advice.</p>
                        </div>
                    </div>
                </div>
            );
        };
        const FilterSidebar = ({ isOpen, onClose, filters, setFilters, traitOptions, showIpConcern, setShowIpConcern, searchByOwner, isOwnerSearching, ownerSearchError }) => {
            const [isLegendModalOpen, setIsLegendModalOpen] = useState(false);
            const [isDisclaimerOpen, setIsDisclaimerOpen] = useState(false);
            const [ownerInput, setOwnerInput] = useState(filters.owner || '');
            useEffect(() => {
                if (filters.owner !== ownerInput) {
                    setOwnerInput(filters.owner || '');
                }
            }, [filters.owner]);
            const handleOwnerSearch = (e) => {
                e.preventDefault();
                searchByOwner(ownerInput);
            };
            const handleFilterChange = useCallback((key, value) => setFilters(prev => ({...prev, [key]: value})), [setFilters]);
            const handleTraitChange = useCallback((traitName, value) => setFilters(prev => {
                const newTraits = { ...prev.traits };
                if (value === '') delete newTraits[traitName];
                else newTraits[traitName] = value;
                return { ...prev, traits: newTraits };
            }), [setFilters]);
            const resetFilters = useCallback(() => {
                setFilters({ id: '', owner: '', rarity: '', traits: {}, ownerFilteredIds: null });
                setShowIpConcern(false);
                setOwnerInput('');
            }, [setFilters, setShowIpConcern]);
            return (
                <>
                    <aside className={`h-screen sticky top-0 bg-white shadow-2xl transition-all duration-300 ease-in-out flex-shrink-0 ${isOpen ? 'w-1/2 md:w-80 lg:w-96' : 'w-0'}`}>
                        <div className="flex flex-col h-full overflow-hidden">
                            <div className="flex justify-between items-center p-4 border-b">
                                <h2 className="text-lg font-semibold">Filters</h2>
                                <button onClick={onClose} className="p-1 rounded-full hover:bg-gray-200"><CloseIcon /></button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-6">
                                <div className="p-3 bg-red-50 rounded-lg border border-red-200">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-2">
                                            <label htmlFor="ip-toggle" className="font-semibold text-red-800 text-sm cursor-pointer">Show IP Risk Items</label>
                                            <button onClick={() => setIsDisclaimerOpen(true)} aria-label="Show IP risk information"><InfoIcon className="h-4 w-4 text-gray-400 hover:text-gray-600" /></button>
                                        </div>
                                        <div className="relative inline-flex items-center">
                                            <input type="checkbox" id="ip-toggle" checked={showIpConcern} onChange={e => setShowIpConcern(e.target.checked)} className="sr-only peer" />
                                            <label htmlFor="ip-toggle" className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-500 cursor-pointer"></label>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <form onSubmit={handleOwnerSearch}>
                                        <label htmlFor="owner-search" className="block text-sm font-medium text-gray-700 mb-2">Search by Owner Address</label>
                                        <div className="flex gap-2">
                                            <input id="owner-search" type="text" value={ownerInput} onChange={e => setOwnerInput(e.target.value)} placeholder="0x..." className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary disabled:bg-gray-100" disabled={isOwnerSearching} />
                                            <button type="submit" className="px-4 py-2 bg-primary text-white font-semibold rounded-md hover:bg-opacity-90 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled={isOwnerSearching || !ownerInput}>{isOwnerSearching ? '...' : 'Go'}</button>
                                        </div>
                                        {ownerSearchError && <p className="text-red-500 text-xs mt-1">{ownerSearchError}</p>}
                                    </form>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2 whitespace-nowrap">
                                        <div className="flex items-center gap-2">
                                            <StarIcon className="h-4 w-4 text-gray-600" />
                                            <span>Filter by Rarity</span>
                                            <button onClick={() => setIsLegendModalOpen(true)} aria-label="Open rarity legend"><InfoIcon className="h-4 w-4 text-gray-400 cursor-pointer hover:text-gray-600" /></button>
                                        </div>
                                    </label>
                                    <select value={filters.rarity} onChange={e => handleFilterChange('rarity', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary bg-white">
                                        <option value="">All Rarities</option>
                                        {RARITY_LEVELS.map(level => <option key={level} value={level}>{level}</option>)}
                                    </select>
                                </div>
                                {Object.entries(traitOptions).map(([traitName, values]) => {
                                    const Icon = TRAIT_ICONS[traitName];
                                    return (
                                        <div key={traitName}>
                                            <label htmlFor={`trait-${traitName}`} className="block text-sm font-medium text-gray-700 mb-2 whitespace-nowrap">
                                                <div className="flex items-center gap-2">
                                                    {Icon && <Icon className='h-4 w-4 text-gray-600' />}
                                                    <span>{traitName}</span>
                                                </div>
                                            </label>
                                            <select id={`trait-${traitName}`} value={filters.traits[traitName] || ''} onChange={e => handleTraitChange(traitName, e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary bg-white">
                                                <option value="">All</option>
                                                {values.map(val => <option key={val} value={val}>{val.split(' (')[0]}</option>)}
                                            </select>
                                        </div>
                                    )
                                })}
                            </div>
                            <div className="p-4 border-t">
                                <button onClick={resetFilters} className="w-full py-2 px-4 bg-red-500 text-white font-semibold rounded-md hover:bg-red-600 transition-colors">Reset Filters</button>
                            </div>
                        </div>
                    </aside>
                    <RarityLegendModal isOpen={isLegendModalOpen} onClose={() => setIsLegendModalOpen(false)} />
                    <IpDisclaimerModal isOpen={isDisclaimerOpen} onClose={() => setIsDisclaimerOpen(false)} />
                </>
            );
        };
        const MemoizedFilterSidebar = memo(FilterSidebar);

        // --- From pages/Gallery.tsx ---
        const Gallery = () => {
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [selectedNft, setSelectedNft] = useState(null);
            const [enlargedImageUrl, setEnlargedImageUrl] = useState(null);
            const [visibleCount, setVisibleCount] = useState(40);
            const [traitForModal, setTraitForModal] = useState(null);
            const [nftForOffer, setNftForOffer] = useState(null);
            const [isAllOffersModalOpen, setIsAllOffersModalOpen] = useState(false);
            const { nfts, filteredNfts, filters, setFilters, traitOptions, loading, error, showIpConcern, setShowIpConcern, traitDetails, searchByOwner, isOwnerSearching, ownerSearchError, hasHiddenIpRiskItems } = useNfts();
            const [idInput, setIdInput] = useState(filters.id);
            useEffect(() => {
                const timer = setTimeout(() => {
                    if (idInput !== filters.id) {
                        setFilters(prev => ({ ...prev, id: idInput }));
                    }
                }, 300);
                return () => clearTimeout(timer);
            }, [idInput, filters.id, setFilters]);
            useEffect(() => {
                setIdInput(filters.id);
            }, [filters.id]);
            useEffect(() => {
                setVisibleCount(40);
                window.scrollTo(0, 0);
            }, [filters, showIpConcern]);
            const observer = useRef(null);
            const lastNftElementRef = useCallback((node) => {
                if (loading) return;
                if (observer.current) observer.current.disconnect();
                observer.current = new IntersectionObserver(entries => {
                    if (entries[0].isIntersecting && visibleCount < filteredNfts.length) {
                        setVisibleCount(prevCount => prevCount + 40);
                    }
                });
                if (node) observer.current.observe(node);
            }, [loading, visibleCount, filteredNfts.length]);
            const handleCardClick = useCallback((nft) => setSelectedNft(nft), []);
            const handleImageClick = useCallback((url) => setEnlargedImageUrl(url), []);
            const handleMakeOffer = useCallback((nft) => {
                setSelectedNft(null); 
                setNftForOffer(nft);
            }, []);
            const visibleNfts = useMemo(() => filteredNfts.slice(0, visibleCount), [filteredNfts, visibleCount]);
            return (
                <div className="relative min-h-screen bg-gray-50">
                    <div className="flex">
                        <div className="flex-1 min-w-0">
                            <main className="w-full p-2 sm:p-4">
                                <div className="w-full flex justify-center items-center gap-2 py-4">
                                    <div className="relative w-full max-w-xs">
                                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <IdIcon className="h-5 w-5 text-gray-400" />
                                        </div>
                                        <input
                                            type="text"
                                            value={idInput}
                                            onChange={e => setIdInput(e.target.value)}
                                            placeholder="Search by ID..."
                                            className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-full focus:ring-primary focus:border-primary shadow-sm"
                                            aria-label="Search by NFT ID"
                                        />
                                    </div>
                                    <button 
                                        onClick={() => setIsAllOffersModalOpen(true)}
                                        className="retro-button px-4 py-2 text-sm font-semibold rounded-full whitespace-nowrap"
                                        aria-label="View all offers"
                                    >
                                        All Offers
                                    </button>
                                </div>
                                {loading && <div className="text-center p-10">Loading NFTs...</div>}
                                {error && <div className="text-center p-10 text-red-500">{error}</div>}
                                {!loading && !error && (
                                    <>
                                        <div className="mb-4 text-center text-sm text-gray-600">
                                            Showing {filteredNfts.length} of {showIpConcern ? nfts.length : nfts.filter(n => !n.isIpConcern).length} NFTs
                                        </div>
                                        <MemoizedActiveFilters filters={filters} setFilters={setFilters} />
                                        {hasHiddenIpRiskItems && (
                                            <div className="mb-4 p-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-md flex items-center justify-between gap-4">
                                                <div className="flex items-center gap-2">
                                                    <InfoIcon />
                                                    <p className="text-sm font-medium">Some search results are hidden due to potential IP risk.</p>
                                                </div>
                                                <button
                                                    onClick={() => setShowIpConcern(true)}
                                                    className="retro-button bg-yellow-500 text-white text-xs font-bold whitespace-nowrap px-3 py-1 rounded-md hover:bg-yellow-600 transition-colors"
                                                >Show All</button>
                                            </div>
                                        )}
                                        <div className="grid gap-3 sm:gap-4 grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5">
                                            {visibleNfts.map((nft, index) => (
                                                <MemoizedNftCard
                                                    ref={visibleNfts.length === index + 1 ? lastNftElementRef : null}
                                                    key={nft.ID}
                                                    nft={nft}
                                                    onCardClick={handleCardClick}
                                                    isSidebarOpen={isSidebarOpen}
                                                />
                                            ))}
                                        </div>
                                    </>
                                )}
                            </main>
                        </div>
                        <MemoizedFilterSidebar
                            isOpen={isSidebarOpen}
                            onClose={() => setIsSidebarOpen(false)}
                            filters={filters}
                            setFilters={setFilters}
                            traitOptions={traitOptions}
                            showIpConcern={showIpConcern}
                            setShowIpConcern={setShowIpConcern}
                            searchByOwner={searchByOwner}
                            isOwnerSearching={isOwnerSearching}
                            ownerSearchError={ownerSearchError}
                        />
                    </div>
                    <button
                        onClick={() => setIsSidebarOpen(true)}
                        className={`fixed bottom-4 right-4 bg-gradient-to-br from-yellow-400 via-amber-500 to-yellow-600 text-white p-4 rounded-full shadow-xl hover:scale-110 transition-all z-40 border-2 border-amber-700 hover:opacity-100 ${isSidebarOpen ? 'opacity-0 pointer-events-none' : 'opacity-70'}`}
                        aria-label="Open filters"
                    >
                        <SlidersIcon />
                    </button>
                    {selectedNft && (
                        <NftModal
                            nft={selectedNft}
                            onClose={() => setSelectedNft(null)}
                            traitDetails={traitDetails}
                            onTraitClick={setTraitForModal}
                            onImageClick={handleImageClick}
                            onMakeOffer={handleMakeOffer}
                        />
                    )}
                    {traitForModal && <TraitDetailModal trait={traitForModal} onClose={() => setTraitForModal(null)} />}
                    {enlargedImageUrl && <ImageModal imageUrl={enlargedImageUrl} onClose={() => setEnlargedImageUrl(null)} />}
                    {nftForOffer && <OfferModal nft={nftForOffer} onClose={() => setNftForOffer(null)} />}
                    <AllOffersModal 
                        isOpen={isAllOffersModalOpen} 
                        onClose={() => setIsAllOffersModalOpen(false)} 
                        nfts={nfts}
                    />
                </div>
            );
        };

        // --- From pages/PlaceholderPage.tsx ---
        const PlaceholderPage = ({ title }) => {
          return (
            <div className="flex items-center justify-center h-full text-2xl text-gray-500 p-8">
              {title} Page - Coming Soon
            </div>
          );
        };
        
        // --- From components/Header.tsx ---
        const Header = () => {
          const navLinkClasses = "px-3 py-2 text-sm font-medium text-gray-300 rounded-md hover:bg-white/20 hover:text-white transition-colors";
          const activeNavLinkClasses = "bg-white/20 text-white";
          return (
            <header className="bg-gradient-to-r from-primary to-secondary shadow-md sticky top-0 z-40">
              <nav className="container mx-auto px-4 py-2 flex justify-center items-center">
                <div className="flex items-center space-x-2 sm:space-x-4">
                  <NavLink to="/" className={({ isActive }) => isActive ? `${navLinkClasses} ${activeNavLinkClasses}` : navLinkClasses}>
                    Gallery
                  </NavLink>
                  <NavLink to="/encyclopedia" className={({ isActive }) => isActive ? `${navLinkClasses} ${activeNavLinkClasses}` : navLinkClasses}>
                    Encyclopedia
                  </NavLink>
                  <NavLink to="/history" className={({ isActive }) => isActive ? `${navLinkClasses} ${activeNavLinkClasses}` : navLinkClasses}>
                    History
                  </NavLink>
                  <NavLink to="/links" className={({ isActive }) => isActive ? `${navLinkClasses} ${activeNavLinkClasses}` : navLinkClasses}>
                    Links
                  </NavLink>
                </div>
              </nav>
            </header>
          );
        };

        // --- From App.tsx ---
        const App = () => {
          return (
            <HashRouter>
              <div className="flex flex-col h-screen overflow-hidden">
                <Header />
                <main className="flex-1 overflow-y-auto">
                  <Routes>
                    <Route path="/" element={<Gallery />} />
                    <Route path="/encyclopedia" element={<PlaceholderPage title="Encyclopedia" />} />
                    <Route path="/history" element={<PlaceholderPage title="History" />} />
                    <Route path="/links" element={<PlaceholderPage title="Links" />} />
                  </Routes>
                </main>
              </div>
            </HashRouter>
          );
        };
        
        // --- From index.tsx (The final render call) ---
        const rootElement = document.getElementById('root');
        if (!rootElement) {
          throw new Error("Could not find root element to mount to");
        }
        const root = ReactDOM.createRoot(rootElement);
        root.render(
          <React.StrictMode>
            <App />
          </React.StrictMode>
        );

    </script>
</body>
</html>
