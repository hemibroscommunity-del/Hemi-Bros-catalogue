
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hemi Bros NFT Gallery</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    
    <style>
      body {
        font-family: 'ui-sans-serif', 'system-ui', sans-serif;
        background-color: #d1d1d1;
        background-image: linear-gradient(45deg, #c6c6c6 25%, transparent 25%), 
                          linear-gradient(-45deg, #c6c6c6 25%, transparent 25%), 
                          linear-gradient(45deg, transparent 75%, #c6c6c6 75%), 
                          linear-gradient(-45deg, transparent 75%, #c6c6c6 75%);
        background-size: 8px 8px;
      }
      
      @keyframes grail-glow {
        0%, 100% { box-shadow: 0 0 15px #e60012, 0 0 25px #ff1a2d; }
        50% { box-shadow: 0 0 30px #ff3344, 0 0 50px #ff4d5d; }
      }
      @keyframes legendary-glow {
        0%, 100% { box-shadow: 0 0 10px #ff9900, 0 0 15px #ff9900; }
        50% { box-shadow: 0 0 20px #ffc966, 0 0 30px #ffc966; }
      }
      @keyframes epic-glow {
        0%, 100% { box-shadow: 0 0 8px #b344f3, 0 0 12px #b344f3; }
        50% { box-shadow: 0 0 16px #c364ff, 0 0 24px #c364ff; }
      }
      @keyframes rare-glow {
        0%, 100% { box-shadow: 0 0 5px #00a800, 0 0 10px #00a800; }
        50% { box-shadow: 0 0 15px #33c333, 0 0 20px #33c333; }
      }
      
      .animate-grail-glow { animation: grail-glow 1s linear infinite; }
      .animate-legendary-glow { animation: legendary-glow 1.8s ease-in-out infinite; }
      .animate-epic-glow { animation: epic-glow 1.5s ease-in-out infinite; }
      .animate-rare-glow { animation: rare-glow 2s ease-in-out infinite; }
    </style>
<script type="importmap">
{
  "imports": {
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "papaparse": "https://aistudiocdn.com/papaparse@^5.5.3"
  }
}
</script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel" data-presets="typescript,react">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- CONSTANTS ---
        const GITHUB_BASE = 'https://raw.githubusercontent.com/hemibroscommunity-del/Hemi-Bros-catalogue/main';
        const TRAIT_GRAPHICS_BASE = GITHUB_BASE;
        const NEW_NFT_DATA_URL = `${GITHUB_BASE}/Hemi%20Bro%20spreadsheet-CleanDataWithImages.csv`;
        const NEW_SUPPLY_COUNT_URL = `${GITHUB_BASE}/Hemi%20Bro%20spreadsheet-SupplyCount.csv`;

        const RARITY_LEVELS = ['Grail', 'Legendary', 'Epic', 'Rare', 'Uncommon', 'Common'];
        const TRAIT_CATEGORIES = ['Bro Type', 'Headwear', 'Clothes', 'Eyes', 'Eyewear', 'Mouth Items'];

        // --- UTILS ---
        const FILENAME_OVERRIDES = {};

        const getTraitKey = (category, name) => {
            if (!name || name === 'None') return null;
            return `${category.toLowerCase()}:${name.toLowerCase()}`;
        };

        const getTraitThumbnailUrl = (category, filename, traitName) => {
            const overrideKey = `${category.toLowerCase()}:${traitName.toLowerCase()}`;
            if (FILENAME_OVERRIDES[overrideKey]) {
                return `${TRAIT_GRAPHICS_BASE}/${encodeURIComponent(category)}/${encodeURIComponent(FILENAME_OVERRIDES[overrideKey])}`;
            }
            if (filename) {
                return `${TRAIT_GRAPHICS_BASE}/${encodeURIComponent(category)}/${encodeURIComponent(filename)}`;
            }
            if (traitName) {
                return `${TRAIT_GRAPHICS_BASE}/${encodeURIComponent(category)}/${encodeURIComponent(traitName)}.png`;
            }
            return null;
        };

        const getRarityFromSupply = (supply) => {
            const num = typeof supply === 'string' ? parseInt(supply, 10) : supply;
            if (isNaN(num)) return { tier: 'Common', color: 'gray' };
            if (num === 1) return { tier: 'Grail', color: 'red' };
            if (num <= 10) return { tier: 'Legendary', color: 'orange' };
            if (num <= 25) return { tier: 'Epic', color: 'purple' };
            if (num <= 50) return { tier: 'Rare', color: 'green' };
            if (num <= 100) return { tier: 'Uncommon', color: 'amber' };
            return { tier: 'Common', color: 'gray' };
        };

        const getNftRarity = (nft) => {
            let minSupply = Infinity;
            TRAIT_CATEGORIES.forEach(cat => {
                const val = nft[cat];
                if (typeof val === 'string') {
                    const match = val.match(/\((\d+)\)/);
                    if (match) {
                        const supply = parseInt(match[1], 10);
                        if (!isNaN(supply) && supply < minSupply) {
                            minSupply = supply;
                        }
                    }
                }
            });
            return getRarityFromSupply(minSupply === Infinity ? 999 : minSupply);
        };

        // --- COMPONENTS ---

        // Icons
        const CloseIcon = ({ className = "h-6 w-6" }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
        );

        const StarIcon = ({ className = "h-5 w-5" }) => (
            <svg className={className} viewBox="0 0 24 24" fill="currentColor">
                <path d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.007z" />
            </svg>
        );

        const FilterIcon = () => (
            <svg className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
            </svg>
        );

        // RarityBadge
        const RarityBadge = ({ tier, showName = true }) => {
            const colors = {
                'Grail': 'bg-red-600',
                'Legendary': 'bg-orange-500',
                'Epic': 'bg-purple-600',
                'Rare': 'bg-green-600',
                'Uncommon': 'bg-amber-700',
                'Common': 'bg-gray-500'
            };
            
            const stars = tier === 'Grail' ? 6 : tier === 'Legendary' ? 5 : tier === 'Epic' ? 4 : tier === 'Rare' ? 3 : tier === 'Uncommon' ? 2 : 1;
            
            return (
                <div className={`flex items-center gap-1 text-xs font-bold text-white px-2 py-0.5 rounded-full ${colors[tier] || 'bg-gray-500'}`}>
                    {[...Array(stars)].map((_, i) => <StarIcon key={i} className="h-3 w-3" />)}
                    {showName && <span>{tier}</span>}
                </div>
            );
        };

        // NFTCard
        const NFTCard = ({ nft, onClick }) => {
            const { tier } = getNftRarity(nft);
            
            const glowClass = tier === 'Grail' ? 'animate-grail-glow' :
                            tier === 'Legendary' ? 'animate-legendary-glow' :
                            tier === 'Epic' ? 'animate-epic-glow' :
                            tier === 'Rare' ? 'animate-rare-glow' : '';
            
            return (
                <div 
                    onClick={() => onClick(nft)}
                    className={`bg-white rounded-lg shadow-md overflow-hidden cursor-pointer hover:scale-105 transition-transform duration-200 ${glowClass}`}
                >
                    <img 
                        src={nft.Image} 
                        alt={`Hemi Bro #${nft.ID}`}
                        className="w-full aspect-square object-cover"
                        loading="lazy"
                    />
                    <div className="p-2 flex justify-between items-center">
                        <span className="font-bold">#{nft.ID}</span>
                        <RarityBadge tier={tier} />
                    </div>
                </div>
            );
        };

        // NFTModal
        const NFTModal = ({ nft, traitDetails, onClose, onTraitClick }) => {
            if (!nft) return null;
            
            return (
                <div className="fixed inset-0 bg-black/60 z-40 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-xl max-w-sm w-full max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
                        <div className="p-3 flex justify-between items-center border-b sticky top-0 bg-white rounded-t-xl z-10">
                            <h2 className="text-xl font-bold text-purple-700">Hemi Bro #{nft.ID}</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-800 hover:bg-gray-100 rounded-full p-1 transition-colors">
                                <CloseIcon />
                            </button>
                        </div>
                        
                        <div className="p-4 overflow-y-auto">
                            <div className="flex justify-center mb-4">
                                    <img 
                                        src={nft.Image}
                                        alt={`Hemi Bro #${nft.ID}`}
                                        className="w-48 h-48 rounded-lg shadow-lg bg-gray-100"
                                    />
                            </div>
                            
                            <div className="space-y-2">
                                {TRAIT_CATEGORIES.map(category => {
                                    const value = nft[category];
                                    if (typeof value !== 'string' || !value || value === 'None') return null;
                                    
                                    const displayValue = value.split(' (')[0];
                                    const match = value.match(/\((\d+)\)/);
                                    const supply = match ? parseInt(match[1], 10) : 999;
                                    
                                    const key = getTraitKey(category, displayValue);
                                    const detail = key ? traitDetails[key] : null;
                                    const rarity = getRarityFromSupply(supply);

                                    const rarityTextColors = {
                                        'Grail': 'text-red-600',
                                        'Legendary': 'text-orange-500',
                                        'Epic': 'text-purple-600',
                                        'Rare': 'text-green-600',
                                        'Uncommon': 'text-amber-700',
                                        'Common': 'text-gray-500'
                                    };
                                    const titleColorClass = rarityTextColors[rarity.tier] || 'text-gray-800';

                                    return (
                                        <button
                                            key={category}
                                            onClick={() => onTraitClick(category, value)}
                                            className="w-full bg-gray-50 p-2 rounded-lg flex items-center gap-3 hover:bg-purple-50 hover:shadow-md transition-all duration-200 border border-gray-100"
                                        >
                                            <div className="flex-shrink-0 w-12 h-12 bg-white rounded-md border border-gray-200 p-1 flex items-center justify-center overflow-hidden">
                                                {detail?.thumbnailUrl ? (
                                                    <img 
                                                        src={detail.thumbnailUrl} 
                                                        alt={displayValue} 
                                                        className="w-full h-full object-contain"
                                                    />
                                                ) : (
                                                    <span className="text-xs text-gray-300">No Img</span>
                                                )}
                                            </div>
                                            
                                            <div className="flex-grow text-left">
                                                <p className="text-xs text-gray-500 uppercase font-bold tracking-wide">{category}</p>
                                                <p className={`font-semibold text-sm ${titleColorClass}`}>
                                                    {displayValue}
                                                </p>
                                            </div>

                                            <div className="flex flex-col items-end gap-1">
                                                <RarityBadge tier={rarity.tier} />
                                                <span className="text-xs text-gray-500 font-mono">{supply} qty</span>
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // TraitDetailModal
        const TraitDetailModal = ({ trait, onClose }) => {
            if (!trait) return null;
            
            const { tier } = getRarityFromSupply(trait.Supply);

            const rarityTextColors = {
                'Grail': 'text-red-600',
                'Legendary': 'text-orange-500',
                'Epic': 'text-purple-600',
                'Rare': 'text-green-600',
                'Uncommon': 'text-amber-700',
                'Common': 'text-gray-500'
            };

            const textColorClass = rarityTextColors[tier] || 'text-gray-800';
            
            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-xl max-w-md w-full p-6 relative" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-3 right-3 text-gray-500 hover:text-gray-800 hover:bg-gray-100 rounded-full p-1 transition-colors">
                            <CloseIcon />
                        </button>
                        
                        {trait.thumbnailUrl && (
                            <div className="flex justify-center mb-4">
                                    <img 
                                        src={trait.thumbnailUrl} 
                                        alt={trait['Unique Item List']}
                                        className="w-32 h-32 object-contain rounded-lg border bg-gray-50 p-1"
                                        onError={(e) => { (e.target).style.display = 'none'; }}
                                    />
                            </div>
                        )}
                        
                        <div className="text-center mb-3">
                            <div className="inline-block">
                                <RarityBadge tier={tier} />
                            </div>
                            <p className="text-xs text-gray-500 mt-2">{trait.Category}</p>
                            <h3 className={`text-2xl font-bold ${textColorClass}`}>{trait['Unique Item List']}</h3>
                            <p className="text-sm text-gray-600">Supply: {trait.Supply}</p>
                        </div>
                        
                        {trait.Title && <h4 className={`font-bold text-center mb-2 ${textColorClass}`}>"{trait.Title}"</h4>}
                        {trait.Description && <p className="text-sm text-gray-700 text-center">{trait.Description}</p>}
                    </div>
                </div>
            );
        };

        // FilterSidebar
        const RaritySelect = ({ value, onChange }) => {
            const [isOpen, setIsOpen] = useState(false);
            const containerRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (containerRef.current && !containerRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            return (
                <div className="mb-2" ref={containerRef}>
                    <label className="block text-xs font-medium mb-0.5 text-gray-700">Rarity</label>
                    <div className="relative">
                        <button 
                            onClick={() => setIsOpen(!isOpen)}
                            className="w-full px-2 py-1.5 bg-white border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:outline-none flex items-center justify-between text-left min-h-[34px]"
                        >
                            <span className="flex items-center gap-2">
                                {value ? <RarityBadge tier={value} showName={false} /> : <span className="text-gray-500 text-sm">All Rarities</span>}
                            </span>
                            <svg className={`w-4 h-4 text-gray-500 transition-transform ${isOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                        </button>

                        {isOpen && (
                            <div className="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto">
                                <div 
                                    className="p-2 hover:bg-gray-100 cursor-pointer text-gray-500 text-sm"
                                    onClick={() => { onChange(''); setIsOpen(false); }}
                                >
                                    All Rarities
                                </div>
                                {RARITY_LEVELS.map(tier => (
                                    <div 
                                        key={tier}
                                        title={tier}
                                        className={`p-2 hover:bg-purple-50 cursor-pointer flex items-center ${value === tier ? 'bg-purple-100' : ''}`}
                                        onClick={() => { onChange(tier); setIsOpen(false); }}
                                    >
                                        <RarityBadge tier={tier} showName={false} />
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const CustomSelect = ({ label, value, options, onChange, category, traitDetails }) => {
            const [isOpen, setIsOpen] = useState(false);
            const containerRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (containerRef.current && !containerRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const selectedName = value ? value.split(' (')[0] : 'All';
            const selectedKey = value ? getTraitKey(category, selectedName) : null;
            const selectedIcon = selectedKey && traitDetails[selectedKey]?.thumbnailUrl;

            return (
                <div className="mb-2" ref={containerRef}>
                    <label className="block text-xs font-medium mb-0.5 text-gray-700">{label}</label>
                    <div className="relative">
                        <button 
                            onClick={() => setIsOpen(!isOpen)}
                            className="w-full px-2 py-1.5 bg-white border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:outline-none flex items-center justify-between text-left min-h-[34px]"
                        >
                            <span className="flex items-center gap-2 truncate">
                                {selectedIcon && <img src={selectedIcon} alt="" className="w-5 h-5 object-contain" />}
                                {selectedName === 'All' ? <span className="text-gray-500 text-sm">Select {label}...</span> : <span className="text-sm">{selectedName}</span>}
                            </span>
                            <svg className={`w-4 h-4 text-gray-500 transition-transform ${isOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                        </button>

                        {isOpen && (
                            <div className="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto">
                                <div 
                                    className="p-2 hover:bg-gray-100 cursor-pointer flex items-center gap-2 text-gray-500"
                                    onClick={() => { onChange(''); setIsOpen(false); }}
                                >
                                    <span className="text-sm">All</span>
                                </div>
                                {options.map(opt => {
                                    const name = opt.split(' (')[0];
                                    const key = getTraitKey(category, name);
                                    const icon = key && traitDetails[key]?.thumbnailUrl;
                                    return (
                                        <div 
                                            key={opt}
                                            className={`p-2 hover:bg-purple-50 cursor-pointer flex items-center gap-3 ${value === opt ? 'bg-purple-100 font-medium' : ''}`}
                                            onClick={() => { onChange(opt); setIsOpen(false); }}
                                        >
                                            {icon ? (
                                                <img src={icon} alt="" className="w-6 h-6 object-contain bg-gray-50 rounded border border-gray-100" />
                                            ) : (
                                                <div className="w-6 h-6 bg-gray-100 rounded border border-gray-200"></div>
                                            )}
                                            <span className="text-sm">{name}</span>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                    
                    {value && (
                        <div className="mt-1 flex">
                            <button 
                                onClick={() => onChange('')}
                                className="flex items-center gap-2 bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full text-xs font-medium hover:bg-purple-200 transition-colors group border border-purple-200"
                            >
                                {selectedIcon && <img src={selectedIcon} alt="" className="w-3 h-3 object-contain" />}
                                {selectedName}
                                <span className="ml-1 text-purple-400 group-hover:text-purple-600"><CloseIcon className="w-3 h-3" /></span>
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        const FilterSidebar = ({ isOpen, onClose, filters, setFilters, traitOptions, traitDetails }) => {
          
          const handleTraitChange = (category, value) => {
            setFilters(prev => {
                const newTraits = { ...prev.traits };
                if (value === '') {
                    delete newTraits[category];
                } else {
                    newTraits[category] = value;
                }
                return { ...prev, traits: newTraits };
            });
          };

          const resetFilters = () => {
            setFilters({ id: '', rarity: '', traits: {} });
          };

          return (
            <React.Fragment>
              <div 
                className={`fixed inset-0 bg-black/30 z-20 transition-opacity ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}
                onClick={onClose}
              />
              <aside className={`fixed right-0 top-0 h-full w-1/2 md:w-80 bg-white shadow-2xl z-30 transform transition-transform ${isOpen ? 'translate-x-0' : 'translate-x-full'} overflow-y-auto flex flex-col`}>
                <div className="p-3 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                  <h2 className="text-lg font-semibold">Filters</h2>
                  <button onClick={onClose} className="text-gray-500 hover:text-gray-800 hover:bg-gray-100 rounded-full p-1 transition-colors">
                    <CloseIcon />
                  </button>
                </div>
                
                <div className="p-3 flex-grow overflow-y-auto">
                  <RaritySelect 
                    value={filters.rarity}
                    onChange={(val) => setFilters(prev => ({ ...prev, rarity: val }))}
                  />
                  
                  <div className="border-t border-gray-100 my-2 pt-1"></div>

                  {TRAIT_CATEGORIES.map(category => (
                    <CustomSelect 
                        key={category}
                        label={category}
                        category={category}
                        value={filters.traits[category] || ''}
                        options={traitOptions[category] || []}
                        onChange={(val) => handleTraitChange(category, val)}
                        traitDetails={traitDetails}
                    />
                  ))}
                </div>
                <div className="p-3 sticky bottom-0 bg-white border-t z-10">
                    <button 
                        onClick={resetFilters}
                        className="w-full py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors shadow-sm font-medium text-sm"
                    >
                        Reset Filters
                    </button>
                </div>
              </aside>
            </React.Fragment>
          );
        };

        // --- APP ---
        const App = () => {
            const [nfts, setNfts] = useState([]);
            const [traitDetails, setTraitDetails] = useState({});
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [selectedNft, setSelectedNft] = useState(null);
            const [selectedTrait, setSelectedTrait] = useState(null);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [filters, setFilters] = useState({ id: '', rarity: '', traits: {} });
            const [idInput, setIdInput] = useState('');

            useEffect(() => {
                const loadData = async () => {
                    try {
                        setLoading(true);
                        const [nftRes, traitRes] = await Promise.all([
                            fetch(NEW_NFT_DATA_URL),
                            fetch(NEW_SUPPLY_COUNT_URL)
                        ]);
                        if (!nftRes.ok || !traitRes.ok) throw new Error('Failed to fetch data from GitHub.');
                        
                        const nftText = await nftRes.text();
                        const traitText = await traitRes.text();
                        
                        const traitMap = await new Promise((resolve, reject) => {
                            Papa.parse(traitText, {
                                header: true, skipEmptyLines: true,
                                complete: (results) => {
                                    const map = {};
                                    results.data.forEach(d => {
                                        if (d.Category && d['Unique Item List']) {
                                            const key = getTraitKey(d.Category, d['Unique Item List']);
                                            if (key) {
                                                const thumbFile = d.ThumbFilename || d.IconName;
                                                const traitName = d['Unique Item List'];
                                                map[key] = { 
                                                    ...d, 
                                                    thumbnailUrl: getTraitThumbnailUrl(d.Category, thumbFile, traitName) 
                                                };
                                            }
                                        }
                                    });
                                    resolve(map);
                                },
                                error: (err) => reject(new Error(`Failed to parse trait data: ${err.message}`))
                            });
                        });

                        await new Promise((resolve, reject) => {
                            Papa.parse(nftText, {
                                header: true, dynamicTyping: true, skipEmptyLines: true,
                                complete: (results) => {
                                    const enriched = results.data.filter(n => n.ID).map((n) => {
                                        const enrichedNft = { ...n };
                                        TRAIT_CATEGORIES.forEach(cat => {
                                            const value = n[cat];
                                            if (value && value !== 'None') {
                                                const name = String(value).split(' (')[0];
                                                const key = getTraitKey(cat, name);
                                                const detail = key ? traitMap[key] : undefined;
                                                if (detail) enrichedNft[cat] = `${name} (${detail.Supply})`;
                                            }
                                        });
                                        return enrichedNft;
                                    });
                                    setNfts(enriched);
                                    setTraitDetails(traitMap);
                                    resolve();
                                },
                                error: (err) => reject(new Error(`Failed to parse NFT data: ${err.message}`))
                            });
                        });
                    } catch (err) {
                        console.error(err);
                        setError(err instanceof Error ? err.message : 'An unknown error occurred');
                    } finally {
                        setLoading(false);
                    }
                };
                loadData();
            }, []);

            useEffect(() => {
                const timer = setTimeout(() => setFilters(prev => ({ ...prev, id: idInput })), 300);
                return () => clearTimeout(timer);
            }, [idInput]);

            const filteredNfts = useMemo(() => {
                return nfts.filter(nft => {
                    if (filters.id && !nft.ID.toString().includes(filters.id)) return false;
                    if (filters.rarity) {
                        if (getNftRarity(nft).tier !== filters.rarity) return false;
                    }
                    for (const [cat, val] of Object.entries(filters.traits)) {
                        if (nft[cat] !== val) return false;
                    }
                    return true;
                });
            }, [nfts, filters]);

            const traitOptions = useMemo(() => {
                const options = {};
                TRAIT_CATEGORIES.forEach(cat => {
                    const values = new Set();
                    nfts.forEach(nft => {
                        const val = nft[cat];
                        if (typeof val === 'string' && val && val !== 'None') values.add(val);
                    });
                    options[cat] = Array.from(values).sort((a, b) => a.localeCompare(b));
                });
                return options;
            }, [nfts]);

            const handleTraitClick = (category, value) => {
                const name = value.split(' (')[0];
                const key = getTraitKey(category, name);
                if (key && traitDetails[key]) setSelectedTrait(traitDetails[key]);
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center"><div className="text-2xl font-bold text-purple-700 animate-pulse">Loading Hemi Bros...</div></div>;
            if (error) return <div className="min-h-screen flex items-center justify-center p-4"><div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative text-center"><strong className="font-bold">Error!</strong><span className="block sm:inline ml-2">{error}</span></div></div>;

            return (
                <div className="min-h-screen">
                    <header className="bg-gradient-to-r from-purple-800 to-gray-700 shadow-lg sticky top-0 z-20">
                        <div className="container mx-auto px-4 py-3"><h1 className="text-3xl md:text-4xl font-bold text-white text-center tracking-wider" style={{ fontFamily: 'VT323, monospace' }}>HEMI BROS NFT GALLERY</h1></div>
                    </header>
                    <main className="container mx-auto p-4">
                        <div className="sticky top-[68px] md:top-[76px] bg-[#d1d1d1] bg-opacity-90 backdrop-blur-sm z-10 py-4 mb-4">
                            <div className="flex justify-center">
                            <input type="search" value={idInput} onChange={e => setIdInput(e.target.value)} placeholder="Search by ID..." className="w-full max-w-xs px-4 py-2 border border-gray-300 rounded-full shadow-md focus:ring-2 focus:ring-purple-500 focus:outline-none"/>
                            </div>
                            <div className="text-center text-sm text-gray-600 mt-4">Showing <span className="font-bold">{filteredNfts.length}</span> of <span className="font-bold">{nfts.length}</span> NFTs</div>
                        </div>
                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                        {filteredNfts.map(nft => <NFTCard key={nft.ID} nft={nft} onClick={setSelectedNft} />)}
                        </div>
                        {filteredNfts.length === 0 && <div className="col-span-full text-center py-12 text-gray-500"><h3 className="text-xl font-semibold">No NFTs Found</h3><p>Try adjusting your filters.</p></div>}
                    </main>
                    <button onClick={() => setIsSidebarOpen(true)} aria-label="Open filters" className="fixed bottom-5 right-5 bg-gradient-to-br from-yellow-400 to-amber-600 text-white p-4 rounded-full shadow-xl hover:scale-110 active:scale-100 transition-transform z-10"><FilterIcon /></button>
                    <FilterSidebar 
                        isOpen={isSidebarOpen} 
                        onClose={() => setIsSidebarOpen(false)} 
                        filters={filters} 
                        setFilters={setFilters} 
                        traitOptions={traitOptions} 
                        traitDetails={traitDetails}
                    />
                    <NFTModal 
                        nft={selectedNft} 
                        traitDetails={traitDetails}
                        onClose={() => setSelectedNft(null)} 
                        onTraitClick={handleTraitClick} 
                    />
                    <TraitDetailModal trait={selectedTrait} onClose={() => setSelectedTrait(null)} />
                </div>
            );
        };

        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);
    </script>
</body>
</html>
