
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hemi Bros NFT Gallery</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    
    <style>
      body {
        font-family: 'ui-sans-serif', 'system-ui', sans-serif;
        background-color: #d1d1d1;
        background-image: linear-gradient(45deg, #c6c6c6 25%, transparent 25%), 
                          linear-gradient(-45deg, #c6c6c6 25%, transparent 25%), 
                          linear-gradient(45deg, transparent 75%, #c6c6c6 75%), 
                          linear-gradient(-45deg, transparent 75%, #c6c6c6 75%);
        background-size: 8px 8px;
      }
      
      /* RPG / Diablo Style Scrollbar */
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1; 
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #c1c1c1; 
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8; 
      }

      /* Glow Animations */
      @keyframes grail-glow {
        0%, 100% { box-shadow: 0 0 15px #e60012, 0 0 25px #ff1a2d; }
        50% { box-shadow: 0 0 30px #ff3344, 0 0 50px #ff4d5d; }
      }
      @keyframes legendary-glow {
        0%, 100% { box-shadow: 0 0 10px #ff9900, 0 0 15px #ff9900; }
        50% { box-shadow: 0 0 20px #ffc966, 0 0 30px #ffc966; }
      }
      @keyframes epic-glow {
        0%, 100% { box-shadow: 0 0 8px #b344f3, 0 0 12px #b344f3; }
        50% { box-shadow: 0 0 16px #c364ff, 0 0 24px #c364ff; }
      }
      @keyframes rare-glow {
        0%, 100% { box-shadow: 0 0 5px #00a800, 0 0 10px #00a800; }
        50% { box-shadow: 0 0 15px #33c333, 0 0 20px #33c333; }
      }
      
      .animate-grail-glow { animation: grail-glow 1s linear infinite; }
      .animate-legendary-glow { animation: legendary-glow 1.8s ease-in-out infinite; }
      .animate-epic-glow { animation: epic-glow 1.5s ease-in-out infinite; }
      .animate-rare-glow { animation: rare-glow 2s ease-in-out infinite; }
    </style>
<script type="importmap">
{
  "imports": {
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "papaparse": "https://aistudiocdn.com/papaparse@^5.5.3"
  }
}
</script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel" data-presets="typescript,react">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- TYPES ---
        interface Nft {
            ID: number;
            Image: string;
            'Bro Type': string;
            'Headwear': string;
            'Clothes': string;
            'Eyes': string;
            'Eyewear': string;
            'Mouth Items': string;
            [key: string]: string | number | boolean;
            hasIpRisk?: boolean;
        }

        interface TraitDetail {
            Category: string;
            'Unique Item List': string;
            Supply: string;
            Title?: string;
            Description?: string;
            ThumbFilename?: string;
            IconName?: string;
            thumbnailUrl?: string | null;
            'IP Risk'?: string | boolean;
        }

        interface TraitMap {
            [key: string]: TraitDetail;
        }

        type RarityTier = 'Grail' | 'Legendary' | 'Epic' | 'Rare' | 'Uncommon' | 'Common';

        interface RarityInfo {
            tier: RarityTier;
            color: string;
        }

        interface Filters {
            id: string;
            rarity: string;
            traits: {
                [key: string]: string;
            };
            showIpRisk: boolean;
        }

        // --- CONSTANTS ---
        const GITHUB_BASE = 'https://cdn.jsdelivr.net/gh/hemibroscommunity-del/Hemi-Bros-catalogue@main';
        const TRAIT_GRAPHICS_BASE = GITHUB_BASE;
        const NEW_NFT_DATA_URL = `${GITHUB_BASE}/Hemi%20Bro%20spreadsheet-CleanDataWithImages.csv`;
        const NEW_SUPPLY_COUNT_URL = `${GITHUB_BASE}/Hemi%20Bro%20spreadsheet-SupplyCount.csv`;

        const RARITY_LEVELS: RarityTier[] = ['Grail', 'Legendary', 'Epic', 'Rare', 'Uncommon', 'Common'];
        const TRAIT_CATEGORIES = ['Bro Type', 'Headwear', 'Clothes', 'Eyes', 'Eyewear', 'Mouth Items'];

        // --- UTILS ---
        const FILENAME_OVERRIDES: Record<string, string> = {};

        const checkIpRisk = (val: any): boolean => {
            if (!val) return false;
            const s = String(val).trim().toLowerCase();
            return ['yes', 'y', 'true', '1'].includes(s);
        };

        const getTraitKey = (category: string, name: string): string | null => {
            if (!name || name === 'None') return null;
            return `${category.trim().toLowerCase()}:${name.trim().toLowerCase()}`;
        };

        const getTraitThumbnailUrl = (category: string, filename: string | undefined | null, traitName: string): string | null => {
            const overrideKey = `${category.toLowerCase()}:${traitName.toLowerCase()}`;
            if (FILENAME_OVERRIDES[overrideKey]) {
                return `${TRAIT_GRAPHICS_BASE}/${encodeURIComponent(category)}/${encodeURIComponent(FILENAME_OVERRIDES[overrideKey])}`;
            }
            if (filename) {
                return `${TRAIT_GRAPHICS_BASE}/${encodeURIComponent(category)}/${encodeURIComponent(filename)}`;
            }
            if (traitName) {
                return `${TRAIT_GRAPHICS_BASE}/${encodeURIComponent(category)}/${encodeURIComponent(traitName)}.png`;
            }
            return null;
        };

        const getRarityFromSupply = (supply: string | number): RarityInfo => {
            const num = typeof supply === 'string' ? parseInt(supply, 10) : supply;
            if (isNaN(num)) return { tier: 'Common', color: 'gray' };
            if (num === 1) return { tier: 'Grail', color: 'red' };
            if (num <= 10) return { tier: 'Legendary', color: 'orange' };
            if (num <= 25) return { tier: 'Epic', color: 'purple' };
            if (num <= 50) return { tier: 'Rare', color: 'green' };
            if (num <= 100) return { tier: 'Uncommon', color: 'amber' };
            return { tier: 'Common', color: 'gray' };
        };

        const getNftRarity = (nft: Nft): RarityInfo => {
            let minSupply = Infinity;
            TRAIT_CATEGORIES.forEach(cat => {
                const val = nft[cat];
                if (typeof val === 'string') {
                    const match = val.match(/\((\d+)\)/);
                    if (match) {
                        const supply = parseInt(match[1], 10);
                        if (!isNaN(supply) && supply < minSupply) {
                            minSupply = supply;
                        }
                    }
                }
            });
            return getRarityFromSupply(minSupply === Infinity ? 999 : minSupply);
        };

        const getRarityTextColor = (tier: string) => {
            const rarityTextColors = {
                'Grail': 'text-red-600',
                'Legendary': 'text-orange-500',
                'Epic': 'text-purple-600',
                'Rare': 'text-green-600',
                'Uncommon': 'text-amber-700',
                'Common': 'text-gray-500'
            };
            return rarityTextColors[tier] || 'text-gray-400';
        };

        // --- COMPONENTS: ICONS ---
        const CloseIcon = ({ className = "h-6 w-6" }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
        );

        const ArrowLeftIcon = ({ className = "h-6 w-6" }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
        );

        const CautionIcon = ({ className = "h-5 w-5" }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                 <path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
            </svg>
        );

        const StarIcon = ({ className = "h-5 w-5" }) => (
            <svg className={className} viewBox="0 0 24 24" fill="currentColor">
                <path d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.007z" />
            </svg>
        );

        const FilterIcon = () => (
            <svg className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
            </svg>
        );

        const BookIcon = ({ className = "h-5 w-5 mr-1" }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
            </svg>
        );

        const GridIcon = ({ className = "h-5 w-5 mr-1" }) => (
             <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25A2.25 2.25 0 0113.5 8.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
            </svg>
        );

        // --- COMPONENTS: RARITY BADGE ---
        const RarityBadge = ({ tier, showName = true, className = "" }) => {
            const colors = {
                'Grail': 'bg-red-600',
                'Legendary': 'bg-orange-500',
                'Epic': 'bg-purple-600',
                'Rare': 'bg-green-600',
                'Uncommon': 'bg-amber-700',
                'Common': 'bg-gray-500'
            };
            
            const stars = tier === 'Grail' ? 6 : tier === 'Legendary' ? 5 : tier === 'Epic' ? 4 : tier === 'Rare' ? 3 : tier === 'Uncommon' ? 2 : 1;
            
            return (
                <div className={`flex items-center gap-1 text-xs font-bold text-white px-2 py-0.5 rounded-full whitespace-nowrap ${colors[tier] || 'bg-gray-500'} ${className}`}>
                    {[...Array(stars)].map((_, i) => <StarIcon key={i} className="h-3 w-3" />)}
                    {showName && <span>{tier}</span>}
                </div>
            );
        };

        // --- COMPONENTS: NFT CARD ---
        const NFTCard = ({ nft, onClick }) => {
            const { tier } = getNftRarity(nft);
            
            const glowClass = tier === 'Grail' ? 'animate-grail-glow' :
                            tier === 'Legendary' ? 'animate-legendary-glow' :
                            tier === 'Epic' ? 'animate-epic-glow' :
                            tier === 'Rare' ? 'animate-rare-glow' : '';
            
            return (
                <div 
                    onClick={() => onClick(nft)}
                    className={`bg-white rounded-lg shadow-md overflow-hidden cursor-pointer hover:scale-105 transition-transform duration-200 ${glowClass} relative`}
                >
                    {nft.hasIpRisk && (
                         <div className="absolute top-1 right-1 bg-yellow-400 text-yellow-900 rounded-full p-1 z-10 shadow-sm" title="Community Flagged IP Risk">
                            <CautionIcon className="w-4 h-4" />
                         </div>
                    )}
                    <img 
                        src={nft.Image} 
                        alt={`Hemi Bro #${nft.ID}`}
                        className="w-full aspect-square object-cover"
                        loading="lazy"
                    />
                    <div className="p-2 flex flex-wrap justify-between items-center gap-y-1">
                        <span className="font-bold text-sm">#{nft.ID}</span>
                        <RarityBadge tier={tier} />
                    </div>
                </div>
            );
        };

        // --- COMPONENTS: ENCYCLOPEDIA ---
        const Encyclopedia = ({ traitDetails, onTraitClick }) => {
            const groupedTraits = useMemo(() => {
                const grouped = {};
                TRAIT_CATEGORIES.forEach(cat => grouped[cat] = []);
                
                Object.values(traitDetails).forEach(trait => {
                    // Use normalized category stored in traitDetails
                    if (trait.Category && grouped[trait.Category]) {
                        grouped[trait.Category].push(trait);
                    }
                });

                // Sort items by supply then name
                Object.keys(grouped).forEach(cat => {
                    grouped[cat].sort((a, b) => {
                        const supplyA = parseInt(a.Supply, 10) || 999;
                        const supplyB = parseInt(b.Supply, 10) || 999;
                        if (supplyA !== supplyB) return supplyA - supplyB;
                        return a['Unique Item List'].localeCompare(b['Unique Item List']);
                    });
                });

                return grouped;
            }, [traitDetails]);

            const getRarityColor = (tier) => {
                switch(tier) {
                    case 'Grail': return '#DC2626';
                    case 'Legendary': return '#F97316';
                    case 'Epic': return '#9333EA';
                    case 'Rare': return '#16A34A';
                    case 'Uncommon': return '#B45309';
                    default: return '#9CA3AF';
                }
            };

            return (
                <div className="space-y-8 pb-12">
                    {TRAIT_CATEGORIES.map(category => {
                        const traits = groupedTraits[category] || [];
                        if (traits.length === 0) return null;

                        return (
                            <div key={category} className="bg-white rounded-xl shadow-md overflow-hidden">
                                <div className="bg-gradient-to-r from-purple-800 to-gray-700 px-6 py-4">
                                     <h2 className="text-2xl font-bold text-white font-serif">{category}</h2>
                                </div>
                                <div className="p-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                                    {traits.map((trait, idx) => {
                                        const { tier } = getRarityFromSupply(trait.Supply);
                                        const hasRisk = checkIpRisk(trait['IP Risk']);

                                        return (
                                            <div 
                                                key={trait['Unique Item List']}
                                                className="border border-gray-200 rounded-lg p-3 hover:shadow-lg transition-shadow cursor-pointer flex flex-col items-center text-center bg-gray-50 hover:bg-white relative group"
                                                onClick={() => onTraitClick(category, trait['Unique Item List'])}
                                            >
                                                {hasRisk && (
                                                    <div className="absolute top-2 right-2 z-10 text-yellow-500" title="IP Risk">
                                                        <CautionIcon className="w-4 h-4" />
                                                    </div>
                                                )}
                                                <div className="w-full aspect-square rounded-md mb-2 overflow-hidden flex items-center justify-center bg-white border border-gray-100">
                                                     {trait.thumbnailUrl ? (
                                                        <img src={trait.thumbnailUrl} alt={trait['Unique Item List']} className="w-full h-full object-contain" loading="lazy" />
                                                     ) : <span className="text-xs text-gray-300">N/A</span>}
                                                </div>
                                                <div className="w-full">
                                                    <div className="text-sm font-bold truncate w-full" title={trait['Unique Item List']}>{trait['Unique Item List']}</div>
                                                    <div className="flex items-center justify-between mt-1">
                                                         <span className="text-xs text-gray-500 font-mono">Qty: {trait.Supply}</span>
                                                         <div className="w-2 h-2 rounded-full" style={{ backgroundColor: getRarityColor(tier) }} title={tier}></div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        // --- COMPONENTS: MODAL (Diablo Style) ---
        const NFTModal = ({ nft, traitDetails, onClose }) => {
            const [activeSlot, setActiveSlot] = useState(null);

            useEffect(() => {
                setActiveSlot(null);
            }, [nft]);

            if (!nft) return null;

            // 2 Columns x 3 Rows
            const slots = [
                { category: 'Headwear', label: 'Head' },
                { category: 'Eyewear', label: 'Eyewear' },
                { category: 'Bro Type', label: 'Bro Type' },
                { category: 'Eyes', label: 'Eyes' },
                { category: 'Clothes', label: 'Torso' },
                { category: 'Mouth Items', label: 'Mouth' },
            ];

            const getSlotData = (category) => {
                const value = nft[category];
                if (!value || typeof value !== 'string' || value === 'None') return null;
                const name = value.split(' (')[0].trim();
                const key = getTraitKey(category, name);
                const detail = key ? traitDetails[key] : null;
                
                const match = value.match(/\((\d+)\)/);
                const supply = match ? parseInt(match[1], 10) : 999;
                const rarity = getRarityFromSupply(supply);
                
                return { name, detail, rarity, supply, value, category };
            };

            const handleSlotClick = (data, category) => {
                if(data) setActiveSlot(data);
            };

            const rarityBorders = {
                'Grail': 'border-red-600 shadow-[0_0_10px_rgba(220,38,38,0.3)]',
                'Legendary': 'border-orange-500 shadow-[0_0_8px_rgba(249,115,22,0.3)]',
                'Epic': 'border-purple-600 shadow-[0_0_8px_rgba(147,51,234,0.3)]',
                'Rare': 'border-green-600 shadow-[0_0_5px_rgba(22,163,74,0.3)]',
                'Uncommon': 'border-amber-700',
                'Common': 'border-gray-400'
            };

            const rarityBgColors = {
                'Grail': 'bg-red-200',
                'Legendary': 'bg-orange-200',
                'Epic': 'bg-purple-200',
                'Rare': 'bg-green-200',
                'Uncommon': 'bg-amber-200',
                'Common': 'bg-gray-200'
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white w-full max-w-5xl h-[85vh] md:h-[80vh] rounded-xl overflow-hidden border border-gray-300 shadow-2xl flex flex-col md:flex-row relative" onClick={e => e.stopPropagation()}>
                        
                        <div className={`w-full md:w-2/3 p-3 md:p-5 flex flex-col items-center bg-gray-100 relative overflow-y-auto ${activeSlot ? 'hidden md:flex' : 'flex'}`}>
                            <button onClick={onClose} className="md:hidden absolute top-4 right-4 text-gray-500 hover:text-black z-10">
                                <CloseIcon />
                            </button>

                            <h2 className="text-2xl font-bold text-gray-800 mb-2 md:mb-4 font-serif tracking-wider text-center">HEMI BRO #{nft.ID}</h2>
                            
                            <div className="flex-grow w-full flex flex-col md:flex-row items-center justify-center gap-6 md:gap-8">
                                <div className="flex flex-col items-center gap-3">
                                    <div className="relative">
                                        <img 
                                            src={nft.Image}
                                            alt={`Hemi Bro #${nft.ID}`}
                                            className="w-40 h-40 md:w-64 md:h-64 object-cover rounded-lg border-4 border-white shadow-xl bg-gray-200"
                                        />
                                        {nft.hasIpRisk && (
                                            <div className="absolute top-2 right-2 bg-yellow-400 text-yellow-900 rounded-full p-1.5 z-10 shadow-lg border border-white" title="Contains IP Risk Content">
                                                <CautionIcon className="w-6 h-6" />
                                            </div>
                                        )}
                                    </div>
                                    <div className="mt-1 scale-100">
                                         <RarityBadge tier={getNftRarity(nft).tier} />
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 grid-rows-3 gap-2 w-full max-w-xs md:max-w-[18rem] h-auto md:h-[300px]">
                                    {slots.map((slot) => {
                                        const data = getSlotData(slot.category);
                                        const isSelected = activeSlot?.category === slot.category;
                                        const borderClass = data ? rarityBorders[data.rarity.tier] : 'border-gray-300 border-dashed';
                                        const bgClass = data ? (rarityBgColors[data.rarity.tier] || 'bg-gray-100') : 'bg-gray-50';
                                        const hasRisk = checkIpRisk(data?.detail?.['IP Risk']);
                                        
                                        return (
                                            <div 
                                                key={slot.category}
                                                onClick={() => handleSlotClick(data, slot.category)}
                                                className={`
                                                    relative rounded border-2 cursor-pointer transition-all duration-200 group flex flex-col items-center overflow-hidden h-[85px] md:h-auto
                                                    ${borderClass}
                                                    ${isSelected ? `ring-2 ring-purple-500 z-10 ${bgClass}` : `hover:opacity-90 ${bgClass}`}
                                                `}
                                            >
                                                {hasRisk && (
                                                    <div className="absolute top-1 right-1 text-yellow-600 z-30" title="IP Risk">
                                                        <CautionIcon className="w-3 h-3" />
                                                    </div>
                                                )}
                                                <div className="flex-grow min-h-0 flex items-center justify-center p-1 w-full relative">
                                                    {data?.detail?.thumbnailUrl ? (
                                                        <img src={data.detail.thumbnailUrl} alt={slot.label} className="max-h-full max-w-full object-contain drop-shadow-sm" />
                                                    ) : data ? (
                                                        <span className="text-xs text-gray-400 font-serif break-words text-center px-1">{data.name}</span>
                                                    ) : (
                                                        <span className="text-gray-300 text-xl opacity-40">Empty</span>
                                                    )}
                                                </div>

                                                {data && (
                                                    <div className="w-full bg-white/50 border-t border-gray-200 py-1 px-0.5 flex flex-col items-center justify-center flex-shrink-0 z-20 h-auto min-h-[36px]">
                                                        <span className={`text-[10px] md:text-[11px] font-bold leading-tight text-center line-clamp-1 w-full px-0.5 ${getRarityTextColor(data.rarity.tier)}`}>{data.name}</span>
                                                        <div className="scale-75 origin-center mt-0.5">
                                                            <RarityBadge tier={data.rarity.tier} showName={false} />
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>

                        <div className={`w-full md:w-1/3 bg-gray-50 border-l border-gray-200 p-6 flex-col relative ${activeSlot ? 'flex' : 'hidden md:flex'}`}>
                            <button onClick={() => setActiveSlot(null)} className="md:hidden absolute top-4 left-4 text-gray-500 hover:text-gray-900 flex items-center gap-1 z-20">
                                <ArrowLeftIcon className="w-5 h-5" /> <span className="text-sm font-bold">Back</span>
                            </button>

                            <button onClick={onClose} className="hidden md:block absolute top-4 right-4 text-gray-400 hover:text-gray-800 transition-colors">
                                <CloseIcon />
                            </button>

                            <div className="h-full flex flex-col mt-8 md:mt-0">
                                {activeSlot ? (
                                    <>
                                        <div className="flex flex-col items-center border-b border-gray-200 pb-6 mb-6">
                                            <div className={`w-24 h-24 rounded-lg border border-gray-200 flex items-center justify-center p-2 mb-4 shadow-sm ${rarityBgColors[activeSlot.rarity.tier] || 'bg-white'} relative`}>
                                                 {checkIpRisk(activeSlot.detail?.['IP Risk']) && (
                                                     <div className="absolute top-1 right-1 text-yellow-600 z-10" title="IP Risk">
                                                        <CautionIcon className="w-4 h-4" />
                                                     </div>
                                                 )}
                                                 {activeSlot.detail?.thumbnailUrl && (
                                                     <img src={activeSlot.detail.thumbnailUrl} className="w-full h-full object-contain" />
                                                 )}
                                            </div>
                                            <div className="mb-2">
                                                <RarityBadge tier={activeSlot.rarity.tier} />
                                            </div>
                                            <h3 className={`text-2xl font-bold text-center font-serif ${getRarityTextColor(activeSlot.rarity.tier)}`}>
                                                {activeSlot.name}
                                            </h3>
                                            <p className="text-gray-400 text-sm uppercase tracking-widest mt-1">{activeSlot.category}</p>
                                        </div>

                                        <div className="flex-grow space-y-6 overflow-y-auto custom-scrollbar pr-2">
                                            {activeSlot.detail?.Title && (
                                                <div className="text-center">
                                                    <h4 className={`text-lg italic font-serif ${getRarityTextColor(activeSlot.rarity.tier)}`}>
                                                        "{activeSlot.detail.Title}"
                                                    </h4>
                                                </div>
                                            )}

                                            {activeSlot.detail?.Description && (
                                                <div className="bg-white p-4 rounded border border-gray-200 shadow-sm">
                                                    <p className="text-gray-600 leading-relaxed font-serif text-lg">
                                                        {activeSlot.detail.Description}
                                                    </p>
                                                </div>
                                            )}
                                            
                                            <div className="mt-auto">
                                                <div className="bg-white p-3 rounded border border-gray-200 text-center shadow-sm w-full">
                                                    <span className="block text-xs text-gray-400 uppercase">Supply</span>
                                                    <span className="text-xl font-mono text-gray-800">{activeSlot.supply}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </>
                                ) : (
                                    <div className="h-full flex flex-col justify-center items-center text-center opacity-40">
                                        <div className="w-20 h-20 mb-4 text-gray-400">
                                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                            </svg>
                                        </div>
                                        <p className="text-gray-500 text-lg font-serif">Select an equipment slot<br/>to view details</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTS: SIDEBAR ---
        const rarityBgColors = {
            'Grail': 'bg-red-200',
            'Legendary': 'bg-orange-200',
            'Epic': 'bg-purple-200',
            'Rare': 'bg-green-200',
            'Uncommon': 'bg-amber-200',
            'Common': 'bg-gray-200'
        };

        const RaritySelect = ({ value, onChange, counts }) => {
            const [isOpen, setIsOpen] = useState(false);
            const containerRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (containerRef.current && !containerRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            return (
                <div className="mb-2" ref={containerRef}>
                    <label className="block text-xs font-medium mb-0.5 text-gray-700">Rarity</label>
                    <div className="relative">
                        <button 
                            onClick={() => setIsOpen(!isOpen)}
                            className="w-full px-2 py-1.5 bg-white border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:outline-none flex items-center justify-between text-left min-h-[34px]"
                        >
                            <span className="flex items-center gap-2">
                                {value ? <RarityBadge tier={value} showName={false} /> : <span className="text-gray-500 text-sm">All Rarities</span>}
                            </span>
                            <svg className={`w-4 h-4 text-gray-500 transition-transform ${isOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                        </button>

                        {isOpen && (
                            <div className="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto">
                                <div 
                                    className="p-2 hover:bg-gray-100 cursor-pointer text-gray-500 text-sm"
                                    onClick={() => { onChange(''); setIsOpen(false); }}
                                >
                                    All Rarities
                                </div>
                                {RARITY_LEVELS.map(tier => {
                                    const count = counts[tier] || 0;
                                    if (count === 0 && value !== tier) return null;
                                    return (
                                        <div 
                                            key={tier}
                                            title={tier}
                                            className={`p-2 hover:bg-purple-50 cursor-pointer flex items-center justify-between ${value === tier ? 'bg-purple-100' : ''}`}
                                            onClick={() => { onChange(tier); setIsOpen(false); }}
                                        >
                                            <div className="flex items-center">
                                                <RarityBadge tier={tier} showName={false} />
                                            </div>
                                            <span className="text-xs text-gray-500 font-mono">({count})</span>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const CustomSelect = ({ label, value, options, onChange, category, traitDetails, counts }) => {
            const [isOpen, setIsOpen] = useState(false);
            const containerRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (containerRef.current && !containerRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const selectedName = value ? value.split(' (')[0] : 'All';
            const selectedKey = value ? getTraitKey(category, selectedName) : null;
            const selectedIcon = selectedKey && traitDetails[selectedKey]?.thumbnailUrl;
            
            let selectedBgClass = 'bg-gray-100';
            if (value) {
                 const match = value.match(/\((\d+)\)/);
                 const supply = match ? parseInt(match[1], 10) : 999;
                 const { tier } = getRarityFromSupply(supply);
                 selectedBgClass = rarityBgColors[tier] || 'bg-gray-100';
            }

            return (
                <div className="mb-2" ref={containerRef}>
                    <label className="block text-xs font-medium mb-0.5 text-gray-700">{label}</label>
                    <div className="relative">
                        <button 
                            onClick={() => setIsOpen(!isOpen)}
                            className="w-full px-2 py-1.5 bg-white border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:outline-none flex items-center justify-between text-left min-h-[34px]"
                        >
                            <span className="flex items-center gap-2 truncate">
                                {selectedIcon && <img src={selectedIcon} alt="" className={`w-5 h-5 object-contain rounded p-0.5 ${selectedBgClass}`} />}
                                {selectedName === 'All' ? <span className="text-gray-500 text-sm">Select {label}...</span> : <span className="text-sm">{selectedName}</span>}
                            </span>
                            <svg className={`w-4 h-4 text-gray-500 transition-transform ${isOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                        </button>

                        {isOpen && (
                            <div className="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto">
                                <div 
                                    className="p-2 hover:bg-gray-100 cursor-pointer flex items-center gap-2 text-gray-500"
                                    onClick={() => { onChange(''); setIsOpen(false); }}
                                >
                                    <span className="text-sm">All</span>
                                </div>
                                {options.map(opt => {
                                     const name = opt.split(' (')[0];
                                     const key = getTraitKey(category, name);
                                     const detail = key ? traitDetails[key] : null;
                                     const icon = detail?.thumbnailUrl;
                                     const count = counts[opt] || 0;
                                     const hasRisk = checkIpRisk(detail?.['IP Risk']);

                                     if (count === 0 && value !== opt) return null;

                                     const match = opt.match(/\((\d+)\)/);
                                     const supply = match ? parseInt(match[1], 10) : 999;
                                     const { tier } = getRarityFromSupply(supply);
                                     const bgClass = rarityBgColors[tier] || 'bg-gray-100';

                                     return (
                                        <div 
                                            key={opt}
                                            className={`p-2 hover:bg-purple-50 cursor-pointer flex items-center justify-between ${value === opt ? 'bg-purple-100 font-medium' : ''}`}
                                            onClick={() => { onChange(opt); setIsOpen(false); }}
                                        >
                                            <div className="flex items-center gap-3 overflow-hidden">
                                                {icon ? (
                                                    <img src={icon} alt="" className={`w-6 h-6 object-contain rounded border border-gray-200 flex-shrink-0 p-0.5 ${bgClass}`} />
                                                ) : (
                                                    <div className={`w-6 h-6 rounded border border-gray-200 flex-shrink-0 ${bgClass}`}></div>
                                                )}
                                                <div className="flex items-center gap-1 min-w-0">
                                                    <span className="text-sm truncate">{name}</span>
                                                    {hasRisk && <CautionIcon className="w-3 h-3 text-yellow-600 flex-shrink-0" />}
                                                </div>
                                            </div>
                                            <span className="text-xs text-gray-400 font-mono ml-2">({count})</span>
                                        </div>
                                     );
                                })}
                            </div>
                        )}
                    </div>
                    
                    {value && (
                        <div className="mt-1 flex">
                            <button 
                                onClick={() => onChange('')}
                                className="flex items-center gap-2 bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full text-xs font-medium hover:bg-purple-200 transition-colors group border border-purple-200"
                            >
                                 {selectedIcon && <img src={selectedIcon} alt="" className={`w-3 h-3 object-contain rounded p-px ${selectedBgClass}`} />}
                                 {selectedName}
                                 <span className="ml-1 text-purple-400 group-hover:text-purple-600"><CloseIcon className="w-3 h-3" /></span>
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        const FilterSidebar = ({ isOpen, onClose, filters, setFilters, traitOptions, traitDetails, facetedCounts }) => {
          
          const handleTraitChange = (category, value) => {
            setFilters(prev => {
                const newTraits = { ...prev.traits };
                if (value === '') {
                    delete newTraits[category];
                } else {
                    newTraits[category] = value;
                }
                return { ...prev, traits: newTraits };
            });
          };

          const resetFilters = () => {
            setFilters({ id: '', rarity: '', traits: {}, showIpRisk: false });
          };

          return (
            <React.Fragment>
              <div 
                className={`fixed inset-0 bg-black/30 z-20 transition-opacity ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}
                onClick={onClose}
              />
              <aside className={`fixed right-0 top-0 h-full w-1/2 md:w-80 bg-white shadow-2xl z-30 transform transition-transform ${isOpen ? 'translate-x-0' : 'translate-x-full'} overflow-y-auto flex flex-col`}>
                <div className="p-3 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                  <h2 className="text-lg font-semibold">Filters</h2>
                  <button onClick={onClose} className="text-gray-500 hover:text-gray-800 hover:bg-gray-100 rounded-full p-1 transition-colors">
                    <CloseIcon />
                  </button>
                </div>
                
                <div className="p-3 flex-grow overflow-y-auto">
                    {/* IP Risk Toggle */}
                    <div className="mb-4 bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                         <div className="flex items-center justify-between">
                            <span className="text-sm font-medium text-yellow-800 flex items-center gap-1">
                                <CautionIcon className="w-4 h-4" /> Show IP Risk Content
                            </span>
                            <label className="relative inline-flex items-center cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    className="sr-only peer"
                                    checked={filters.showIpRisk}
                                    onChange={(e) => setFilters(prev => ({...prev, showIpRisk: e.target.checked}))}
                                />
                                <div className="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-yellow-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-yellow-500"></div>
                            </label>
                         </div>
                         <p className="text-[10px] text-yellow-700 mt-1 leading-tight">
                            Includes items flagged by the community as having potential IP risks.
                         </p>
                    </div>

                  <RaritySelect 
                    value={filters.rarity}
                    onChange={(val) => setFilters(prev => ({ ...prev, rarity: val }))}
                    counts={facetedCounts.rarity}
                  />
                  
                  <div className="border-t border-gray-100 my-2 pt-1"></div>

                  {TRAIT_CATEGORIES.map(category => (
                    <CustomSelect 
                        key={category}
                        label={category}
                        category={category}
                        value={filters.traits[category] || ''}
                        options={traitOptions[category] || []}
                        onChange={(val) => handleTraitChange(category, val)}
                        traitDetails={traitDetails}
                        counts={facetedCounts.traits[category] || {}}
                    />
                  ))}
                </div>
                <div className="p-3 sticky bottom-0 bg-white border-t z-10">
                    <button 
                        onClick={resetFilters}
                        className="w-full py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors shadow-sm font-medium text-sm"
                    >
                        Reset Filters
                    </button>
                </div>
              </aside>
            </React.Fragment>
          );
        };

        // --- APP ---
        const App = () => {
            const [currentView, setCurrentView] = useState('gallery'); // 'gallery' | 'encyclopedia'
            const [nfts, setNfts] = useState([]);
            const [traitDetails, setTraitDetails] = useState({});
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [selectedNft, setSelectedNft] = useState(null);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [filters, setFilters] = useState({ id: '', rarity: '', traits: {}, showIpRisk: false });
            const [idInput, setIdInput] = useState('');

            useEffect(() => {
                const loadData = async () => {
                    try {
                        setLoading(true);
                        const [nftRes, traitRes] = await Promise.all([
                            fetch(NEW_NFT_DATA_URL),
                            fetch(NEW_SUPPLY_COUNT_URL)
                        ]);
                        if (!nftRes.ok || !traitRes.ok) throw new Error('Failed to fetch data from GitHub.');
                        
                        const nftText = await nftRes.text();
                        const traitText = await traitRes.text();
                        
                        const traitMap = await new Promise((resolve, reject) => {
                            Papa.parse(traitText, {
                                header: true, skipEmptyLines: true,
                                complete: (results) => {
                                    const map = {};
                                    results.data.forEach(d => {
                                        // Find Category and Item Name columns if standard names aren't found
                                        const keys = Object.keys(d);
                                        let categoryVal = d.Category;
                                        let itemListVal = d['Unique Item List'];

                                        if (!categoryVal || !itemListVal) {
                                            const catKey = keys.find(k => k.trim().toLowerCase() === 'category');
                                            const itemKey = keys.find(k => ['unique item list', 'item name', 'trait name'].includes(k.trim().toLowerCase()));
                                            if (catKey) categoryVal = d[catKey];
                                            if (itemKey) itemListVal = d[itemKey];
                                        }

                                        if (categoryVal && itemListVal) {
                                            // Normalize Category Names to match canonical TRAIT_CATEGORIES
                                            let category = categoryVal.trim();
                                            const lowerCat = category.toLowerCase();
                                            
                                            if (lowerCat === 'head' || lowerCat === 'hats') category = 'Headwear';
                                            else if (lowerCat === 'face' || lowerCat === 'glasses') category = 'Eyewear';
                                            else if (lowerCat === 'mouth') category = 'Mouth Items';
                                            else if (lowerCat === 'torso' || lowerCat === 'clothing' || lowerCat === 'shirt') category = 'Clothes';
                                            else if (lowerCat === 'base' || lowerCat === 'body') category = 'Bro Type';
                                            
                                            // Use the normalized category for the key
                                            const key = getTraitKey(category, itemListVal);
                                            
                                            if (key) {
                                                const thumbFile = d.ThumbFilename || d.IconName;
                                                
                                                // 1. Check for "IP Concern" specifically as requested
                                                // 2. Fallback to "IP Risk"
                                                // 3. Fallback to fuzzy search
                                                let ipRiskVal = d['IP Concern'] || d['IP Risk'];
                                                
                                                if (ipRiskVal === undefined) {
                                                    const riskKey = keys.find(k => {
                                                        const clean = k.trim().toLowerCase();
                                                        return clean === 'ip concern' || clean === 'ip risk' || clean.includes('ip concern') || clean.includes('ip risk');
                                                    });
                                                    if (riskKey) ipRiskVal = d[riskKey];
                                                }

                                                map[key] = { 
                                                    ...d, 
                                                    Category: category, // Store the normalized category
                                                    'IP Risk': ipRiskVal,
                                                    'Unique Item List': itemListVal.trim(), // Ensure item name is accessible
                                                    thumbnailUrl: getTraitThumbnailUrl(category, thumbFile, itemListVal) 
                                                };
                                            }
                                        }
                                    });
                                    resolve(map);
                                },
                                error: (err) => reject(new Error(`Failed to parse trait data: ${err.message}`))
                            });
                        });

                        await new Promise((resolve, reject) => {
                            Papa.parse(nftText, {
                                header: true, dynamicTyping: true, skipEmptyLines: true,
                                complete: (results) => {
                                    const enriched = results.data.filter(n => n.ID).map((n) => {
                                        const enrichedNft = { ...n };
                                        let hasRisk = false;
                                        
                                        // Identify keys in the NFT data that correspond to our categories
                                        const nftKeys = Object.keys(n);

                                        TRAIT_CATEGORIES.forEach(cat => {
                                            // Try exact match first, then case-insensitive match
                                            let keyInNft = cat;
                                            if (n[cat] === undefined) {
                                                keyInNft = nftKeys.find(k => k.trim().toLowerCase() === cat.toLowerCase()) || cat;
                                            }
                                            
                                            // Also handle mapping "Head" in NFT csv to "Headwear" category
                                            if (n[keyInNft] === undefined) {
                                                 if (cat === 'Headwear') keyInNft = nftKeys.find(k => k.trim().toLowerCase() === 'head') || keyInNft;
                                                 if (cat === 'Bro Type') keyInNft = nftKeys.find(k => k.trim().toLowerCase() === 'body' || k.trim().toLowerCase() === 'base') || keyInNft;
                                                 if (cat === 'Clothes') keyInNft = nftKeys.find(k => k.trim().toLowerCase() === 'torso' || k.trim().toLowerCase() === 'clothing') || keyInNft;
                                                 if (cat === 'Eyewear') keyInNft = nftKeys.find(k => k.trim().toLowerCase() === 'face' || k.trim().toLowerCase() === 'glasses') || keyInNft;
                                                 if (cat === 'Mouth Items') keyInNft = nftKeys.find(k => k.trim().toLowerCase() === 'mouth') || keyInNft;
                                            }

                                            const value = n[keyInNft];
                                            if (value && value !== 'None') {
                                                const name = String(value).split(' (')[0].trim(); // trim whitespace
                                                const key = getTraitKey(cat, name);
                                                const detail = key ? traitMap[key] : undefined;
                                                if (detail) {
                                                    enrichedNft[cat] = `${name} (${detail.Supply})`;
                                                    if (checkIpRisk(detail['IP Risk'])) hasRisk = true;
                                                } else {
                                                    // Even if no supply detail, ensure the trait is accessible via standard key
                                                    enrichedNft[cat] = name; 
                                                }
                                            }
                                        });
                                        enrichedNft.hasIpRisk = hasRisk;
                                        return enrichedNft;
                                    });
                                    setNfts(enriched);
                                    setTraitDetails(traitMap);
                                    resolve();
                                },
                                error: (err) => reject(new Error(`Failed to parse NFT data: ${err.message}`))
                            });
                        });
                    } catch (err) {
                        console.error(err);
                        setError(err instanceof Error ? err.message : 'An unknown error occurred');
                    } finally {
                        setLoading(false);
                    }
                };
                loadData();
            }, []);

            useEffect(() => {
                const timer = setTimeout(() => setFilters(prev => ({ ...prev, id: idInput })), 300);
                return () => clearTimeout(timer);
            }, [idInput]);

            const filteredNfts = useMemo(() => {
                return nfts.filter(nft => {
                    if (!filters.showIpRisk && nft.hasIpRisk) return false;
                    
                    if (filters.id && nft.ID.toString() !== filters.id && filters.id !== '') return false;
                    
                    if (filters.rarity) {
                        if (getNftRarity(nft).tier !== filters.rarity) return false;
                    }
                    for (const [cat, val] of Object.entries(filters.traits)) {
                        if (nft[cat] !== val) return false;
                    }
                    return true;
                });
            }, [nfts, filters]);

            // DYNAMIC FACETED COUNTS LOGIC
            const facetedCounts = useMemo(() => {
                const counts = {
                    rarity: {},
                    traits: {}
                };
                TRAIT_CATEGORIES.forEach(cat => counts.traits[cat] = {});

                const matchesFilters = (nft, excludeCategory) => {
                    if (!filters.showIpRisk && nft.hasIpRisk) return false;
                    if (filters.id && nft.ID.toString() !== filters.id && filters.id !== '') return false;
                    
                    if (excludeCategory !== 'rarity' && filters.rarity) {
                        if (getNftRarity(nft).tier !== filters.rarity) return false;
                    }

                    for (const [cat, val] of Object.entries(filters.traits)) {
                        if (excludeCategory !== cat && val && nft[cat] !== val) return false;
                    }
                    return true;
                };

                // Calculate Rarity Counts
                nfts.forEach(nft => {
                    if (matchesFilters(nft, 'rarity')) {
                        const tier = getNftRarity(nft).tier;
                        counts.rarity[tier] = (counts.rarity[tier] || 0) + 1;
                    }
                });

                // Calculate Trait Counts
                TRAIT_CATEGORIES.forEach(cat => {
                    nfts.forEach(nft => {
                        if (matchesFilters(nft, cat)) {
                            const val = nft[cat];
                            if (typeof val === 'string' && val && val !== 'None') {
                                counts.traits[cat][val] = (counts.traits[cat][val] || 0) + 1;
                            }
                        }
                    });
                });
                return counts;
            }, [nfts, filters]);

            const traitOptions = useMemo(() => {
                const options = {};
                TRAIT_CATEGORIES.forEach(cat => {
                    const values = new Set();
                    nfts.forEach(nft => {
                        const val = nft[cat];
                        if (typeof val === 'string' && val && val !== 'None') values.add(val);
                    });
                    options[cat] = Array.from(values).sort((a, b) => a.localeCompare(b));
                });
                return options;
            }, [nfts]);

            const handleTraitClick = (category, value) => {
                const name = value.split(' (')[0];
                const key = getTraitKey(category, name);
                if (key && traitDetails[key]) setSelectedTrait(traitDetails[key]);
            };
            
            const handleEncyclopediaClick = (category, traitName) => {
                const key = getTraitKey(category, traitName);
                if (key && traitDetails[key]) {
                    const fullValue = `${traitName} (${traitDetails[key].Supply})`;
                    setFilters(prev => ({
                        ...prev,
                        traits: {
                            ...prev.traits,
                            [category]: fullValue
                        },
                        showIpRisk: checkIpRisk(traitDetails[key]['IP Risk']) ? true : prev.showIpRisk
                    }));
                    setCurrentView('gallery');
                }
            };
            
            // Check if a search is hidden by IP Risk
            const hiddenByIpRisk = useMemo(() => {
                if (idInput && filteredNfts.length === 0) {
                    const nft = nfts.find(n => n.ID.toString() === idInput);
                    if (nft && nft.hasIpRisk && !filters.showIpRisk) {
                        return true;
                    }
                }
                return false;
            }, [idInput, filteredNfts.length, nfts, filters.showIpRisk]);

            if (loading) return <div className="min-h-screen flex items-center justify-center"><div className="text-2xl font-bold text-purple-700 animate-pulse">Loading Hemi Bros...</div></div>;
            if (error) return <div className="min-h-screen flex items-center justify-center p-4"><div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative text-center"><strong className="font-bold">Error!</strong><span className="block sm:inline ml-2">{error}</span></div></div>;

            return (
                <div className="min-h-screen flex flex-col">
                    <header className="bg-gradient-to-r from-purple-800 to-gray-700 shadow-lg sticky top-0 z-20">
                        <div className="container mx-auto px-4 py-3 flex flex-col md:flex-row items-center justify-between gap-4">
                            <h1 className="text-3xl md:text-4xl font-bold text-white tracking-wider cursor-pointer" style={{ fontFamily: 'VT323, monospace' }} onClick={() => setCurrentView('gallery')}>HEMI BROS NFT GALLERY</h1>
                            <div className="flex bg-gray-900/30 rounded-lg p-1">
                                <button 
                                    onClick={() => setCurrentView('gallery')}
                                    className={`px-4 py-1.5 rounded-md text-sm font-bold transition-all flex items-center ${currentView === 'gallery' ? 'bg-white text-purple-900 shadow' : 'text-gray-200 hover:text-white hover:bg-white/10'}`}
                                >
                                    <GridIcon /> Gallery
                                </button>
                                <button 
                                    onClick={() => setCurrentView('encyclopedia')}
                                    className={`px-4 py-1.5 rounded-md text-sm font-bold transition-all flex items-center ${currentView === 'encyclopedia' ? 'bg-white text-purple-900 shadow' : 'text-gray-200 hover:text-white hover:bg-white/10'}`}
                                >
                                    <BookIcon /> Encyclopedia
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="container mx-auto p-4 flex-grow">
                        {currentView === 'gallery' ? (
                            <>
                                <div className="sticky top-[72px] bg-[#d1d1d1] bg-opacity-90 backdrop-blur-sm z-10 py-4 mb-4">
                                    <div className="flex justify-center">
                                    <input type="search" value={idInput} onChange={e => setIdInput(e.target.value)} placeholder="Search by ID..." className="w-full max-w-xs px-4 py-2 border border-gray-300 rounded-full shadow-md focus:ring-2 focus:ring-purple-500 focus:outline-none"/>
                                    </div>
                                    <div className="text-center text-sm text-gray-600 mt-4">Showing <span className="font-bold">{filteredNfts.length}</span> of <span className="font-bold">{nfts.length}</span> NFTs</div>
                                    
                                    {hiddenByIpRisk && (
                                        <div className="max-w-md mx-auto mt-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded shadow-md">
                                            <div className="flex">
                                                <div className="flex-shrink-0">
                                                    <CautionIcon className="h-5 w-5 text-yellow-400" />
                                                </div>
                                                <div className="ml-3">
                                                    <p className="text-sm text-yellow-700">
                                                        Item <span className="font-bold">#{idInput}</span> has been community flagged with one or more items that have IP risk.
                                                    </p>
                                                    <div className="mt-2">
                                                        <button 
                                                            onClick={() => setFilters(prev => ({ ...prev, showIpRisk: true }))}
                                                            className="text-sm font-medium text-yellow-800 hover:text-yellow-900 underline"
                                                        >
                                                            Show IP Risk Content
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                
                                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                                {filteredNfts.map(nft => <NFTCard key={nft.ID} nft={nft} onClick={setSelectedNft} />)}
                                </div>
                                
                                {filteredNfts.length === 0 && !hiddenByIpRisk && (
                                    <div className="col-span-full text-center py-12 text-gray-500"><h3 className="text-xl font-semibold">No NFTs Found</h3><p>Try adjusting your filters.</p></div>
                                )}
                            </>
                        ) : (
                            <Encyclopedia traitDetails={traitDetails} onTraitClick={handleEncyclopediaClick} />
                        )}
                    </main>

                    {currentView === 'gallery' && (
                        <>
                            <button onClick={() => setIsSidebarOpen(true)} aria-label="Open filters" className="fixed bottom-5 right-5 bg-gradient-to-br from-yellow-400 to-amber-600 text-white p-4 rounded-full shadow-xl hover:scale-110 active:scale-100 transition-transform z-10"><FilterIcon /></button>
                            <FilterSidebar 
                                isOpen={isSidebarOpen} 
                                onClose={() => setIsSidebarOpen(false)} 
                                filters={filters} 
                                setFilters={setFilters} 
                                traitOptions={traitOptions} 
                                traitDetails={traitDetails}
                                facetedCounts={facetedCounts}
                            />
                        </>
                    )}
                    
                    <NFTModal 
                        nft={selectedNft} 
                        traitDetails={traitDetails}
                        onClose={() => setSelectedNft(null)} 
                    />
                </div>
            );
        };

        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);
    </script>
</body>
</html>
